//! https://github.com/dfinity/pocketic
use std::str::FromStr;

use candid::{Nat, Principal, encode_one};
use pocket_ic::PocketIc;

mod archive_swap;
mod archive_token;
mod icrc2;
mod swap;

// 2T cycles
const INIT_CYCLES: u128 = 2_000_000_000_000;

const WASM_MODULE: &[u8] = include_bytes!("../sources/source_opt.wasm");
const ICRC2_WASM_MODULE: &[u8] = include_bytes!("../../../ledger/ic-icrc1-ledger.wasm");
const ARCHIVE_TOKEN_WASM_MODULE: &[u8] = include_bytes!("../../archive-token/sources/source_opt.wasm");
const ARCHIVE_SWAP_WASM_MODULE: &[u8] = include_bytes!("../../archive-swap/sources/source_opt.wasm");

#[ignore]
#[test]
#[rustfmt::skip]
fn test_swap_business_apis() {
    let pic = PocketIc::new();

    let default_identity = Principal::from_text("2ibo7-dia").unwrap();
    let alice_identity = Principal::from_text("uuc56-gyb").unwrap();
    let bob_identity = Principal::from_text("hqgi5-iic").unwrap(); // cspell: disable-line
    let carol_identity = Principal::from_text("jmf34-nyd").unwrap();
    let anonymous_identity = Principal::from_text("2vxsx-fae").unwrap();

    let canister_id = Principal::from_text("piwiu-wiaaa-aaaaj-azzka-cai").unwrap();
    let token_icp_canister_id = Principal::from_text("ryjl3-tyaaa-aaaaa-aaaba-cai").unwrap();
    let token_sns_icx_canister_id = Principal::from_text("lvfsa-2aaaa-aaaaq-aaeyq-cai").unwrap();
    let token_ck_btc_canister_id = Principal::from_text("mxzaz-hqaaa-aaaar-qaada-cai").unwrap();
    let token_ck_eth_canister_id = Principal::from_text("ss2fx-dyaaa-aaaar-qacoq-cai").unwrap();
    let token_ck_usdt_canister_id = Principal::from_text("cngnf-vqaaa-aaaar-qag4q-cai").unwrap();
    let token_sns_chat_canister_id = Principal::from_text("2ouva-viaaa-aaaaq-aaamq-cai").unwrap();
    let archive_token_canister_id = Principal::from_text("ykio2-paaaa-aaaaj-az5ka-cai").unwrap();
    let archive_swap_canister_id = Principal::from_text("hcnys-xiaaa-aaaai-q3w4q-cai").unwrap();

    fn account(owner: Principal) -> Account {
        Account { owner, subaccount: None }
    }
    fn icrc2_account(owner: Principal) -> icrc2::Account {
        icrc2::Account { owner, subaccount: None }
    }
    fn archive_token_account(owner: Principal) -> archive_token::Account {
        archive_token::Account { owner, subaccount: None }
    }
    fn archive_swap_account(owner: Principal) -> archive_swap::Account {
        archive_swap::Account { owner, subaccount: None }
    }
    fn nat(value: u64) -> candid::Nat {
        Nat::from(value)
    }
    fn principal(text: &str) -> Principal {
        Principal::from_text(text).unwrap()
    }

    pic.create_canister_with_id(Some(default_identity), None, canister_id).unwrap();
    pic.add_cycles(canister_id, 20_000_000_000_000);
    pic.install_canister(canister_id, WASM_MODULE.to_vec(), encode_one(None::<()>).unwrap(), Some(default_identity));

    pic.create_canister_with_id(Some(default_identity), None, archive_token_canister_id).unwrap();
    pic.add_cycles(archive_token_canister_id, INIT_CYCLES);
    pic.install_canister(archive_token_canister_id, ARCHIVE_TOKEN_WASM_MODULE.to_vec(), encode_one(Some(archive_token::InitArgs::V1(archive_token::InitArgV1{ maintainers: Some(vec![default_identity]), block_offset: None, host_canister_id: Some(canister_id), max_memory_size_bytes: None }))).unwrap(), Some(default_identity));
    #[allow(unused)] let archive_token = archive_token::PocketedCanisterId::new(archive_token_canister_id, &pic);

    pic.create_canister_with_id(Some(default_identity), None, archive_swap_canister_id).unwrap();
    pic.add_cycles(archive_swap_canister_id, INIT_CYCLES);
    pic.install_canister(archive_swap_canister_id, ARCHIVE_SWAP_WASM_MODULE.to_vec(), encode_one(Some(archive_swap::InitArgs::V1(archive_swap::InitArgV1{ maintainers: None, block_offset: None, host_canister_id: Some(canister_id), max_memory_size_bytes: None }))).unwrap(), Some(default_identity));
    #[allow(unused)] let archive_swap = archive_swap::PocketedCanisterId::new(archive_swap_canister_id, &pic);

    // ! 0. deploy tokens
    #[allow(unused)] let token_sns_icx = deploy_icrc2(&pic, default_identity, token_sns_icx_canister_id, "snsICX", 8, 100000, vec![(default_identity, 1_000_000_000_000)], alice_identity);
    #[allow(unused)] let token_ck_btc = deploy_icrc2(&pic, default_identity, token_ck_btc_canister_id, "ckBTC", 8, 10, vec![(default_identity, 100_000_000)], alice_identity);
    #[allow(unused)] let token_ck_eth = deploy_icrc2(&pic, default_identity, token_ck_eth_canister_id, "ckETH", 18, 2_000_000_000_000, vec![(default_identity, 10_000_000_000_000_000_000), (alice_identity, 8_000_000_000_000_000_000)], alice_identity);
    #[allow(unused)] let token_ck_usdt = deploy_icrc2(&pic, default_identity, token_ck_usdt_canister_id, "ckUSDT", 6, 10000, vec![(default_identity, 100_000_000_000_000)], alice_identity);
    #[allow(unused)] let token_sns_chat = deploy_icrc2(&pic, default_identity, token_sns_chat_canister_id, "snsCHAT", 8, 100000, vec![(default_identity, 1_000_000_000_000)], alice_identity);

    use swap::*;

    let pocketed_canister_id = PocketedCanisterId::new(canister_id, &pic);
    #[allow(unused)] let default = pocketed_canister_id.sender(default_identity);
    #[allow(unused)] let alice = pocketed_canister_id.sender(alice_identity);
    #[allow(unused)] let bob = pocketed_canister_id.sender(bob_identity);
    #[allow(unused)] let carol = pocketed_canister_id.sender(carol_identity);
    #[allow(unused)] let anonymous = pocketed_canister_id.sender(anonymous_identity);

    default.test_config_token_current_archiving_replace(CurrentArchiving { canister_id: archive_token_canister_id, length: 0, max_length: 1_000_000, block_height_offset: 0 }).unwrap();
    default.test_config_swap_current_archiving_replace(CurrentArchiving { canister_id: archive_swap_canister_id, length: 0, max_length: 1_000_000, block_height_offset: 0 }).unwrap();

    // 🚩 0 query balances
    assert_eq!(token_sns_icx.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(1_000_000_000_000));
    assert_eq!(token_sns_icx.sender(alice_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(0));
    assert_eq!(token_sns_icx.sender(bob_identity).icrc1_balance_of(icrc2_account(bob_identity)).unwrap(), nat(0));
    assert_eq!(token_ck_btc.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(100_000_000));
    assert_eq!(token_ck_btc.sender(alice_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(0));
    assert_eq!(token_ck_btc.sender(bob_identity).icrc1_balance_of(icrc2_account(bob_identity)).unwrap(), nat(0));
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(10_000_000_000_000_000_000));
    assert_eq!(token_ck_eth.sender(alice_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(8_000_000_000_000_000_000));
    assert_eq!(token_ck_eth.sender(bob_identity).icrc1_balance_of(icrc2_account(bob_identity)).unwrap(), nat(0));
    assert_eq!(token_ck_usdt.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(100_000_000_000_000));
    assert_eq!(token_ck_usdt.sender(alice_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(0));
    assert_eq!(token_ck_usdt.sender(bob_identity).icrc1_balance_of(icrc2_account(bob_identity)).unwrap(), nat(0));
    assert_eq!(token_sns_chat.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(1_000_000_000_000));
    assert_eq!(token_sns_chat.sender(alice_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(0));
    assert_eq!(token_sns_chat.sender(bob_identity).icrc1_balance_of(icrc2_account(bob_identity)).unwrap(), nat(0));

    assert_eq!(alice.permission_query().unwrap(), ["PauseQuery", "PermissionQuery", "BusinessTokenDeposit", "BusinessTokenWithdraw", "BusinessTokenTransfer", "BusinessTokenPairLiquidityAdd", "BusinessTokenPairLiquidityRemove", "BusinessTokenPairSwap"].iter().map(|p| p.to_string()).collect::<Vec<_>>());
    assert_eq!(default.permission_query().unwrap(), ["PauseQuery", "PauseReplace", "PermissionQuery", "PermissionFind", "PermissionUpdate", "ScheduleFind", "ScheduleReplace", "ScheduleTrigger", "BusinessConfigFeeTo", "BusinessConfigCustomToken", "BusinessConfigMaintaining", "BusinessTokenBalanceBy", "BusinessTokenDeposit", "BusinessTokenWithdraw", "BusinessTokenTransfer", "BusinessTokenPairCreateOrRemove", "BusinessTokenPairLiquidityAdd", "BusinessTokenPairLiquidityRemove", "BusinessTokenPairSwap"].iter().map(|p| p.to_string()).collect::<Vec<_>>());

    // 🚩 1 business tokens
    let symbols = alice.tokens_query().unwrap().iter().map(|t| t.symbol.clone()).collect::<Vec<_>>();
    assert_eq!(symbols.contains(&"ICP".to_string()), true);
    assert_eq!(symbols.contains(&"ckUSDT".to_string()), true);
    assert_eq!(alice.token_query(token_icp_canister_id).unwrap().unwrap().name, "Internet Computer".to_string());
    assert_eq!(alice.token_balance_of(token_sns_icx_canister_id, account(default_identity)).unwrap_err().reject_message.contains("You can only query your own balance"), true);
    assert_eq!(default.token_balance_by(token_sns_icx_canister_id, account(alice_identity)).unwrap(), nat(0));
    assert_eq!(default.token_balance_of(token_sns_icx_canister_id, account(default_identity)).unwrap(), nat(0));
    assert_tokens_balance(default.tokens_balance_of(account(default_identity)).unwrap(), vec![(token_sns_icx_canister_id, nat(0))]);

    // 🚩 1.1 business tokens deposit
    assert_eq!(default.token_deposit(TokenDepositArgs { token: token_ck_eth_canister_id, from: account(default_identity), deposit_amount_without_fee: nat(5_000_000_000_000_000_000), to: account(default_identity), fee: None, created: None, memo: None }, Some(100)).unwrap_err().reject_message.contains("Too many retries"), true);
    assert_eq!(default.token_deposit(TokenDepositArgs { token: token_ck_eth_canister_id, from: account(default_identity), deposit_amount_without_fee: nat(5_000_000_000_000_000_000), to: account(default_identity), fee: None, created: None, memo: None }, None).unwrap(), TokenChangedResult::Err(BusinessError::TransferFromError(TransferFromError::InsufficientAllowance { allowance: nat(0) })));
    assert_eq!(token_ck_eth.sender(default_identity).icrc2_approve(icrc2::ApproveArgs::new(icrc2_account(canister_id), nat(1_000_000_000_000_000_000))).unwrap(), icrc2::Result2::Ok(nat(2)));
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(9_999_998_000_000_000_000));
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(8_000_000_000_000_000_000));
    assert_eq!(default.token_deposit(TokenDepositArgs { token: token_ck_eth_canister_id, from: account(default_identity), deposit_amount_without_fee: nat(5_000_000_000_000_000_000), to: account(default_identity), fee: None, created: None, memo: None }, None).unwrap(), TokenChangedResult::Err(BusinessError::TransferFromError(TransferFromError::InsufficientAllowance { allowance: nat(1_000_000_000_000_000_000) })));
    assert_eq!(token_ck_eth.sender(default_identity).icrc2_approve(icrc2::ApproveArgs::new(icrc2_account(canister_id), nat(10_000_000_000_000_000_000))).unwrap(), icrc2::Result2::Ok(nat(3)));
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(9_999_996_000_000_000_000));
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(8_000_000_000_000_000_000));
    assert_eq!(alice.request_trace_index_get().unwrap_err().reject_message, "Permission 'BusinessConfigMaintaining' is required".to_string());
    assert_eq!(default.request_trace_index_get().unwrap(), (0, 0));
    assert_eq!(default.request_trace_get(0).unwrap(), None); // 👁︎
    assert_eq!(alice.block_token_get(1).unwrap_err().reject_message, "Only Maintainers are allowed to query data".to_string()); // 👁︎
    assert_eq!(default.block_token_get(1).unwrap_err().reject_message.contains("invalid block height"), true); // 👁︎
    assert_eq!(default.block_token_get(0).unwrap_err().reject_message.contains("invalid block height"), true); // 👁︎
    assert_eq!(archive_token.sender(default_identity).get_block(0).unwrap(), None); // 👁︎
    assert_eq!(default.token_deposit(TokenDepositArgs { token: token_ck_eth_canister_id, from: account(default_identity), deposit_amount_without_fee: nat(5_000_000_000_000_000_000), to: account(default_identity), fee: None, created: None, memo: None }, None).unwrap(), TokenChangedResult::Ok(nat(4)));
    std::thread::sleep(std::time::Duration::from_secs(2)); // 🕰︎
    assert_token_block_deposit(archive_token.sender(default_identity).get_block(0).unwrap().unwrap(), archive_token::DepositToken { token: token_ck_eth_canister_id, from: archive_token_account(default_identity), amount: nat(5_000_000_000_000_000_000), to: archive_token_account(default_identity) }); // 👁︎
    assert_eq!(default.block_token_get(0).unwrap(), QueryTokenBlockResult::Archive(archive_token_canister_id)); // 👁︎
    assert_eq!(default.request_trace_get(0).unwrap().unwrap().traces[0].1, format!("*Deposit* `token:[{}], from:({}.), to:({}.), amount:5_000_000_000_000_000_000, height:4`", token_ck_eth_canister_id.to_text(), default_identity.to_text(), default_identity.to_text())); // 👁︎

    // 🚩 1.2 business tokens balance of
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(4_999_994_000_000_000_000));
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(8_000_002_000_000_000_000));
    assert_eq!(default.token_balance_of(token_ck_eth_canister_id, account(default_identity)).unwrap(), nat(5_000_000_000_000_000_000));
    assert_tokens_balance(default.tokens_balance_of(account(default_identity)).unwrap(), vec![(token_ck_eth_canister_id, nat(5_000_000_000_000_000_000))]);

    // 🚩 1.3 business tokens withdraw
    assert_eq!(default.token_withdraw(TokenWithdrawArgs { token: token_ck_eth_canister_id, from: account(default_identity), withdraw_amount_without_fee: nat(15_000_000_000_000_000_000), to: account(default_identity), fee: None, created: None, memo: None }, None).unwrap(), TokenChangedResult::Err(BusinessError::InsufficientBalance { token: token_ck_eth_canister_id, balance: nat(5_000_000_000_000_000_000) }));
    assert_eq!(default.request_trace_get(1).unwrap(), None); // 👁︎
    assert_eq!(default.block_token_get(1).unwrap_err().reject_message.contains("invalid block height"), true); // 👁︎
    assert_eq!(archive_token.sender(default_identity).get_block(1).unwrap(), None); // 👁︎
    assert_eq!(default.token_withdraw(TokenWithdrawArgs { token: token_ck_eth_canister_id, from: account(default_identity), withdraw_amount_without_fee: nat(999_998_000_000_000_000), to: account(default_identity), fee: None, created: None, memo: None }, None).unwrap(), TokenChangedResult::Ok(nat(5)));
    std::thread::sleep(std::time::Duration::from_secs(2)); // 🕰︎
    assert_token_block_withdraw(archive_token.sender(default_identity).get_block(1).unwrap().unwrap(), archive_token::DepositToken { token: token_ck_eth_canister_id, from: archive_token_account(default_identity), amount: nat(1_000_000_000_000_000_000), to: archive_token_account(default_identity) }); // 👁︎
    assert_eq!(default.block_token_get(1).unwrap(), QueryTokenBlockResult::Archive(archive_token_canister_id)); // 👁︎
    assert_eq!(default.request_trace_get(1).unwrap().unwrap().traces[0].1, format!("*Withdraw* `token:[{}], from:({}.), to:({}.), amount:1_000_000_000_000_000_000, height:5`", token_ck_eth_canister_id.to_text(), default_identity.to_text(), default_identity.to_text())); // 👁︎
    assert_tokens_balance(default.tokens_balance_of(account(default_identity)).unwrap(), vec![(token_ck_eth_canister_id, nat(4_000_000_000_000_000_000))]);

    // 🚩 1.4 business tokens balance of
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(default_identity)).unwrap(), nat(5_999_992_000_000_000_000));
    assert_eq!(token_ck_eth.sender(default_identity).icrc1_balance_of(icrc2_account(alice_identity)).unwrap(), nat(8_000_004_000_000_000_000));
    assert_eq!(default.token_balance_of(token_ck_eth_canister_id, account(default_identity)).unwrap(), nat(4_000_000_000_000_000_000));
    assert_tokens_balance(default.tokens_balance_of(account(default_identity)).unwrap(), vec![(token_ck_eth_canister_id, nat(4_000_000_000_000_000_000))]);

    // 🚩 1.5 business tokens transfer
    assert_eq!(alice.token_balance_of(token_ck_eth_canister_id, account(alice_identity)).unwrap(), nat(0));
    assert_eq!(default.token_transfer(TokenTransferArgs { token: token_ck_eth_canister_id, from: account(default_identity), transfer_amount_without_fee: Nat::from_str("1_000_000_000_000_000_000_000").unwrap(), to: account(alice_identity), fee: None, created: None, memo: None }, None).unwrap(), TokenChangedResult::Err(BusinessError::InsufficientBalance { token: token_ck_eth_canister_id, balance: nat(4_000_000_000_000_000_000) }));
    assert_eq!(default.request_trace_get(2).unwrap(), None); // 👁︎
    assert_eq!(default.block_token_get(2).unwrap_err().reject_message.contains("invalid block height"), true); // 👁︎
    assert_eq!(archive_token.sender(default_identity).get_block(2).unwrap(), None); // 👁︎
    assert_eq!(default.token_transfer(TokenTransferArgs { token: token_ck_eth_canister_id, from: account(default_identity), transfer_amount_without_fee: nat(1_000_000_000_000_000_000), to: account(alice_identity), fee: None, created: None, memo: None }, None).unwrap(), TokenChangedResult::Ok(nat(1_000_000_000_000_000_000)));
    std::thread::sleep(std::time::Duration::from_secs(2)); // 🕰︎
    assert_token_block_transfer(archive_token.sender(default_identity).get_block(2).unwrap().unwrap(), archive_token::TransferToken { token: token_ck_eth_canister_id, from: archive_token_account(default_identity), amount: nat(1_000_000_000_000_000_000), to: archive_token_account(alice_identity), fee: None }); // 👁︎
    assert_eq!(default.block_token_get(2).unwrap(), QueryTokenBlockResult::Archive(archive_token_canister_id)); // 👁︎
    assert_eq!(default.request_trace_get(2).unwrap().unwrap().traces[0].1, format!("*Transfer* `token:[{}], from:({}.), to:({}.), amount:1_000_000_000_000_000_000`", token_ck_eth_canister_id.to_text(), default_identity.to_text(), alice_identity.to_text())); // 👁︎
    assert_eq!(default.token_balance_of(token_ck_eth_canister_id, account(default_identity)).unwrap(), nat(3_000_000_000_000_000_000));
    assert_eq!(alice.token_balance_of(token_ck_eth_canister_id, account(alice_identity)).unwrap(), nat(1_000_000_000_000_000_000));

    // 🚩 2 business pairs
    let token_ck_eth_token_ck_usdt_dummy_canister_id = Principal::from_text("vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4").unwrap();
    assert_eq!(alice.pairs_query().unwrap(), Vec::new());
    assert_eq!(alice.pair_query(TokenPairPool { token0: token_ck_eth_canister_id, token1: token_ck_usdt_canister_id, amm: "swap_v2_0.3%".to_string() }).unwrap(), None);
    assert_eq!(alice.pair_create(TokenPairCreateOrRemoveArgs { pool: TokenPairPool { token0: token_ck_eth_canister_id, token1: token_ck_usdt_canister_id, amm: "swap_v2_0.3%".to_string() }, memo: None, created: None }).unwrap_err().reject_message, "Permission 'BusinessTokenPairCreateOrRemove' is required".to_string());
    assert_eq!(default.tokens_balance_of(account(default_identity)).unwrap().contains(&(token_ck_eth_token_ck_usdt_dummy_canister_id, nat(0))), false);
    assert_eq!(alice.block_swap_get(1).unwrap_err().reject_message.contains("invalid block height"), true); // 👁︎
    assert_eq!(default.request_trace_get(3).unwrap(), None); // 👁︎
    assert_eq!(default.block_swap_get(0).unwrap_err().reject_message.contains("invalid block height"), true); // 👁︎
    assert_eq!(archive_swap.sender(default_identity).get_block(0).unwrap(), None); // 👁︎
    assert_eq!(default.pair_create(TokenPairCreateOrRemoveArgs { pool: TokenPairPool { token0: token_ck_eth_canister_id, token1: token_ck_usdt_canister_id, amm: "swap_v2_0.3%".to_string() }, memo: None, created: None }).unwrap(), TokenPairCreateOrRemoveResult::Ok(MarketMakerView::SwapV2(SwapV2MarketMakerView { lp: PoolLp::Inner(InnerLp { fee: nat(100_000_000), decimals: 12, dummy_canister_id: token_ck_eth_token_ck_usdt_dummy_canister_id, minimum_liquidity: nat(100_000_000_000), total_supply: nat(0) }), price_cumulative_exponent: 64, block_timestamp_last: 0, reserve0: "0".to_string(), reserve1: "0".to_string(), subaccount: "11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c".to_string(), price1_cumulative_last: "0".to_string(), token0: token_ck_eth_canister_id.to_text(), token1: token_ck_usdt_canister_id.to_text(), fee_rate: "3/1000".to_string(), k_last: "0".to_string(), protocol_fee: Some("1/6".to_string()), price0_cumulative_last: "0".to_string() })));
    std::thread::sleep(std::time::Duration::from_secs(2)); // 🕰︎
    archive_swap.sender(canister_id).append_blocks(vec![]).unwrap(); // ! BUG
    assert_eq!(default.block_swap_get(0).unwrap(), QuerySwapBlockResult::Archive(archive_swap_canister_id)); // 👁︎
    assert_swap_block_pair_create(archive_swap.sender(default_identity).get_block(0).unwrap().unwrap(), archive_swap::PairCreate { pa: archive_swap::TokenPairAmm { pair: archive_swap::TokenPair { token0: token_ck_eth_canister_id, token1: token_ck_usdt_canister_id  }, amm: archive_swap::Amm::SwapV2T3 }, creator: default_identity  }); // 👁︎
    assert_eq!(default.block_swap_get(0).unwrap(), QuerySwapBlockResult::Archive(archive_swap_canister_id)); // 👁︎
    assert_eq!(default.request_trace_get(3).unwrap().unwrap().traces[0].1, format!("*TokenPairCreate* `token0:[{}], token1:[{}], amm:swap_v2_0.3%, subaccount:(11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), dummyCanisterId:[{}]`", token_ck_eth_canister_id.to_text(), token_ck_usdt_canister_id.to_text(), token_ck_eth_token_ck_usdt_dummy_canister_id.to_text())); // 👁︎
    assert_eq!(default.request_trace_get(4).unwrap(), None); // 👁︎
    assert_eq!(alice.pairs_query().unwrap()[0], (TokenPairPool { token0: token_ck_eth_canister_id, token1: token_ck_usdt_canister_id, amm: "swap_v2_0.3%".to_string() }, MarketMakerView::SwapV2(SwapV2MarketMakerView { lp: PoolLp::Inner(InnerLp { fee: nat(100_000_000), decimals: 12, dummy_canister_id: token_ck_eth_token_ck_usdt_dummy_canister_id, minimum_liquidity: nat(100_000_000_000), total_supply: nat(0) }), price_cumulative_exponent: 64, block_timestamp_last: 0, reserve0: "0".to_string(), reserve1: "0".to_string(), subaccount: "11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c".to_string(), price1_cumulative_last: "0".to_string(), token0: token_ck_eth_canister_id.to_text(), token1: token_ck_usdt_canister_id.to_text(), fee_rate: "3/1000".to_string(), k_last: "0".to_string(), protocol_fee: Some("1/6".to_string()), price0_cumulative_last: "0".to_string() })));
    assert_eq!(alice.pair_query(TokenPairPool { token0: token_ck_eth_canister_id, token1: token_ck_usdt_canister_id, amm: "swap_v2_0.3%".to_string() }).unwrap().unwrap(), MarketMakerView::SwapV2(SwapV2MarketMakerView { lp: PoolLp::Inner(InnerLp { fee: nat(100_000_000), decimals: 12, dummy_canister_id: token_ck_eth_token_ck_usdt_dummy_canister_id, minimum_liquidity: nat(100_000_000_000), total_supply: nat(0) }), price_cumulative_exponent: 64, block_timestamp_last: 0, reserve0: "0".to_string(), reserve1: "0".to_string(), subaccount: "11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c".to_string(), price1_cumulative_last: "0".to_string(), token0: token_ck_eth_canister_id.to_text(), token1: token_ck_usdt_canister_id.to_text(), fee_rate: "3/1000".to_string(), k_last: "0".to_string(), protocol_fee: Some("1/6".to_string()), price0_cumulative_last: "0".to_string() }));
    assert_tokens_balance(default.tokens_balance_of(account(default_identity)).unwrap(), vec![(token_ck_eth_canister_id, nat(3_000_000_000_000_000_000)), (token_ck_usdt_canister_id, nat(0)), (token_ck_eth_token_ck_usdt_dummy_canister_id, nat(0))]);
    let token_ck_eth_token_ck_usdt_subaccount = hex::decode("11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c").unwrap();
    assert_tokens_balance(alice.tokens_balance_of(Account { owner: canister_id, subaccount: Some(token_ck_eth_token_ck_usdt_subaccount.into()) }).unwrap(), vec![(token_ck_eth_canister_id, nat(0)), (token_ck_usdt_canister_id, nat(0)), (token_ck_eth_token_ck_usdt_dummy_canister_id, nat(0))]);

// blue "\n🚩 2.1 business pair liquidity add"
// test "pair_liquidity_add" "$(dfx --identity alice canister call swap pair_liquidity_add "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; amount_desired=record{1:nat;1:nat}; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" "( variant { Err = variant { NotOwner = principal \"$DEFAULT\" } }, )"
// test "pair_liquidity_add" "$(dfx --identity default canister call swap pair_liquidity_add "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; amount_desired=record{2_000_000_000_000_000_000:nat;200_000_000_000:nat}; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '( variant { Err = variant { InsufficientBalance = record { token = principal "cngnf-vqaaa-aaaar-qag4q-cai"; balance = 0 : nat; } } }, )'
// test "icrc2_approve token_ckUSDT/default" "$(dfx --identity default canister call token_ckUSDT icrc2_approve "(record { spender=record{owner=principal \"$swap\";}; amount=900_000_000_000:nat })" 2>&1)" '(variant { Ok = 1 : nat })'
// test "token_deposit" "$(dfx --identity default canister call swap token_deposit "(record { token=principal \"$token_ckUSDT\"; from=record{owner=principal \"$DEFAULT\"; subaccount=null}; deposit_amount_without_fee=800_000_000_000: nat; to=record{owner=principal \"$DEFAULT\"; subaccount=null}; }, null)" 2>&1)" '(variant { Ok = 2 : nat })'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(3:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "800_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ]'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(3:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(4:nat64)" 2>&1)" '( opt record { created = ' ' : nat64; args = variant { token_deposit = record { arg = record { to = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; token = principal "cngnf-vqaaa-aaaar-qag4q-cai"; from = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; amount = 800_000_000_000 : nat; }; now = ' ' : nat64; created = null; memo = null; caller = principal "'"$DEFAULT"'"; } }; done = opt record { result = variant { ok = "2" }; done = ' ' : nat64; }; traces = vec { record { ' ' : nat64; "*Deposit* `token:[cngnf-vqaaa-aaaar-qag4q-cai], from:('"$DEFAULT"'.), to:('"$DEFAULT"'.), amount:800_000_000_000, height:2`"; }; record { ' ' : nat64; "Deposit Done." }; }; locks = record { token = opt true; swap = null; balances = opt vec { record { token = principal "cngnf-vqaaa-aaaar-qag4q-cai"; account = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; }; }; }; index = 4 : nat64; }, )'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(5:nat64)" 2>&1)" '(null)'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(4:nat64)" 2>&1)" '(null)'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(5:nat64)" 2>&1)" '(null)'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(6:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(4:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(5:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(6:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(1:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(1:nat64)" 2>&1)" '(null)'
// test "pair_liquidity_add" "$(dfx --identity default canister call swap pair_liquidity_add "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; amount_desired=record{2_000_000_000_000_000_000:nat;400_000_000_000:nat}; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '( variant { Ok = record { liquidity = 894_427_190_999_915 : nat; amount = record { 2_000_000_000_000_000_000 : nat; 400_000_000_000 : nat; }; } }, )'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(1:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint": { "amount": "894_427_190_999_915", "amount0": "2_000_000_000_000_000_000", "amount1": "400_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } } ]'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(1:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(2:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(3:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(4:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "2_000_000_000_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(5:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "400_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(6:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "894_427_190_999_915", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } } ]'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(4:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(5:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(6:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(7:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(5:nat64)" --output json 2>&1)" '[ { "args": { "pair_liquidity_add": { "arg": { "amount_a_desired": "2_000_000_000_000_000_000", "amount_a_min": "1", "amount_b_desired": "400_000_000_000", "amount_b_min": "1", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "self_canister": "piwiu-wiaaa-aaaaj-azzka-cai", "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ss2fx-dyaaa-aaaar-qacoq-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "' '", "result": { "ok": "{\"amount\":[\"2_000_000_000_000_000_000\",\"400_000_000_000\"],\"liquidity\":\"894_427_190_999_915\"}" } } ], "index": "5", "locks": { "balances": [ [ { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(5:nat64)" --output json 2>&1)" '"subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } ] ], "swap": [ true ], "token": [ true ] }, "traces": [ { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(5:nat64)" --output json 2>&1)" '", "1": "*PairLiquidityAdd* `tokenA:[ss2fx-dyaaa-aaaar-qacoq-cai], tokenB:[cngnf-vqaaa-aaaar-qag4q-cai], amm:swap_v2_0.3%, required: 1 <= amount_a <= 2_000_000_000_000_000_000 && 1 <= amount_b <= 400_000_000_000`" }, { "0": "' '", "1": "*TokenTransfer* `token:[ss2fx-dyaaa-aaaar-qacoq-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), amount:2_000_000_000_000_000_000, done:2_000_000_000_000_000_000`" }, { "0": "' '", "1": "*TokenTransfer* `token:[cngnf-vqaaa-aaaar-qag4q-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), amount:400_000_000_000, done:400_000_000_000`" }, { "0": "' '", "1": "*PairLiquidityAdd* `amount_a:2_000_000_000_000_000_000, amount_b:400_000_000_000`" }, { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(5:nat64)" --output json 2>&1)" '", "1": "*PairLiquidityMint(Deposit)* `token:[vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4], from[transferred 2 tokens]:('"$DEFAULT"'.), to[minted liquidity]:('"$DEFAULT"'.), amount:894_427_190_999_915`" }, { "0": "' '", "1": "*PairLiquidityMint* `token:[vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4], to:('"$DEFAULT"'.), amount:894_427_190_999_915`" }, { "0": "' '", "1": "Token Pair Add Liquidity Done." } ] } ]'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(6:nat64)" 2>&1)" '(null)'
// test "pairs_query" "$(dfx --identity alice canister call swap pairs_query 2>&1)" '( vec { record { record { amm = "swap_v2_0.3%"; token0 = principal "ss2fx-dyaaa-aaaar-qacoq-cai"; token1 = principal "cngnf-vqaaa-aaaar-qag4q-cai"; }; variant { swap_v2 = record { lp = variant { inner = record { fee = 100_000_000 : nat; decimals = 12 : nat8; dummy_canister_id = principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; minimum_liquidity = 100_000_000_000 : nat; total_supply = 894_427_190_999_915 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = ' ' : nat64; reserve0 = "2_000_000_000_000_000_000"; reserve1 = "400_000_000_000"; subaccount = "11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c"; price1_cumulative_last = "0"; token0 = "ss2fx-dyaaa-aaaar-qacoq-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "0"; } }; }; }, )'
// test "pair_query" "$(dfx --identity alice canister call swap pair_query "(record { token0 = principal \"$token_ckETH\"; token1 = principal \"$token_ckUSDT\"; amm = \"swap_v2_0.3%\"; })" >&1)" '( opt variant { swap_v2 = record { lp = variant { inner = record { fee = 100_000_000 : nat; decimals = 12 : nat8; dummy_canister_id = principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; minimum_liquidity = 100_000_000_000 : nat; total_supply = 894_427_190_999_915 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = ' ' : nat64; reserve0 = "2_000_000_000_000_000_000"; reserve1 = "400_000_000_000"; subaccount = "11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c"; price1_cumulative_last = "0"; token0 = "ss2fx-dyaaa-aaaar-qacoq-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "0"; } }, )'
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\";                                    subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 1_000_000_000_000_000_000 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 400_000_000_000 : nat;}' 'record { principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; 894_427_190_999_915 : nat;}'
// test "tokens_balance_of pool" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$swap\"; subaccount=opt blob \"$token_ckETH_token_ckUSDT_subaccount\" })" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 2_000_000_000_000_000_000 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 400_000_000_000 : nat;}' 'record { principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; 0 : nat;}'

// blue "\n🚩 2.2 business pair liquidity remove"
// test "pair_liquidity_remove" "$(dfx --identity default canister call swap pair_liquidity_remove "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; liquidity_without_fee=1_894_427_190_999_915:nat; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '(variant { Err = variant { Liquidity = "INSUFFICIENT_LIQUIDITY" } })'
// test "pair_liquidity_remove" "$(dfx --identity default canister call swap pair_liquidity_remove "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; liquidity_without_fee=894_327_190_999_916:nat; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '(variant { Err = variant { Liquidity = "REMAIN_TOTAL_LIQUIDITY_TOO_SMALL" } })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(7:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(7:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(8:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(9:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(7:nat64)" 2>&1)" '(null)'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(8:nat64)" 2>&1)" '(null)'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(9:nat64)" 2>&1)" '(null)'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(3:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(3:nat64)" 2>&1)" '(null)'
// test "pair_liquidity_remove" "$(dfx --identity default canister call swap pair_liquidity_remove "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; liquidity_without_fee=447_213_595_499_958:nat; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '( variant { Ok = record { amount = record { 1_000_000_000_000_001_118 : nat; 200_000_000_000 : nat; }; } }, )'
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(3:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "burn": { "amount": "447_213_595_499_958", "amount0": "1_000_000_000_000_001_118", "amount1": "200_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(4:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "999_999_999_999_998_882", "reserve1": "200_000_000_000", "supply": "447_213_595_499_957" } } } } } } ]'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(3:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(4:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(5:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(7:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "447_213_595_499_958", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(8:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_000_000_000_000_001_118", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(9:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "200_000_000_000", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(10:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(7:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(8:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(9:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(10:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(6:nat64)" --output json 2>&1)" '[ { "args": { "pair_liquidity_remove": { "arg": { "amount_a_min": "1", "amount_b_min": "1", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "liquidity_without_fee": "447_213_595_499_958", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "self_canister": "piwiu-wiaaa-aaaaj-azzka-cai", "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ss2fx-dyaaa-aaaar-qacoq-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(6:nat64)" --output json 2>&1)" '", "result": { "ok": "{\"amount\":[\"1_000_000_000_000_001_118\",\"200_000_000_000\"]}" } } ], "index": "6", "locks": { "balances": [ [ { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(6:nat64)" --output json 2>&1)" '"token": "ss2fx-dyaaa-aaaar-qacoq-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } ] ], "swap": [ true ], "token": [ true ] }, "traces": [ { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(6:nat64)" --output json 2>&1)" '", "1": "*PairLiquidityRemove* `tokenA:[ss2fx-dyaaa-aaaar-qacoq-cai], tokenB:[cngnf-vqaaa-aaaar-qag4q-cai], amm:swap_v2_0.3%, liquidity_without_fee:447_213_595_499_958, required: 1 <= amount_a && 1 <= amount_b`" }, { "0": "' '", "1": "*PairLiquidityBurn(Withdraw)*. `token:[vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4], from[burned liquidity]:('"$DEFAULT"'.), to[withdrawn 2 tokens]:('"$DEFAULT"'.), amount:447_213_595_499_958, fee:None`" }, { "0": "' '", "1": "*PairLiquidityBurn* `token:[vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4], from:('"$DEFAULT"'.), amount:447_213_595_499_958`" }, { "0": "' '", "1": "*TokenTransfer* `token:[ss2fx-dyaaa-aaaar-qacoq-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), to:('"$DEFAULT"'.), amount:1_000_000_000_000_001_118, done:1_000_000_000_000_001_118`" }, { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(6:nat64)" --output json 2>&1)" '", "1": "*TokenTransfer* `token:[cngnf-vqaaa-aaaar-qag4q-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), to:('"$DEFAULT"'.), amount:200_000_000_000, done:200_000_000_000`" }, { "0": "' '", "1": "*SwapV2State* `pa:([ss2fx-dyaaa-aaaar-qacoq-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), timestamp:' ', exponent:64, price0_cumulative:' ', price1_cumulative:' '`" }, { "0": "' '", "1": "Token Pair Remove Liquidity Done." } ] } ]'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(7:nat64)" 2>&1)" '(null)'
// test "pair_query" "$(dfx --identity alice canister call swap pair_query "(record { token0 = principal \"$token_ckETH\"; token1 = principal \"$token_ckUSDT\"; amm = \"swap_v2_0.3%\"; })" >&1)" '( opt variant { swap_v2 = record { lp = variant { inner = record { fee = 100_000_000 : nat; decimals = 12 : nat8; dummy_canister_id = principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; minimum_liquidity = 100_000_000_000 : nat; total_supply = 447_213_595_499_957 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = ' ' : nat64; reserve0 = "999_999_999_999_998_882"; reserve1 = "200_000_000_000"; subaccount = "11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c"; price1_cumulative_last = "' '"; token0 = "ss2fx-dyaaa-aaaar-qacoq-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "' '"; } }, )'
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\";                                    subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 2_000_000_000_000_001_118 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 600_000_000_000 : nat;}' 'record { principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; 447_213_595_499_957 : nat;}'
// test "tokens_balance_of pool" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$swap\"; subaccount=opt blob \"$token_ckETH_token_ckUSDT_subaccount\" })" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 999_999_999_999_998_882 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 200_000_000_000 : nat;}' 'record { principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; 0 : nat;}'

// blue "\n🚩 2.3 business pair swap extra tokens for tokens"
// test "pair_swap_exact_tokens_for_tokens" "$(dfx --identity default canister call swap pair_swap_exact_tokens_for_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_in=100_000_000:nat; amount_out_min=100_000_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '( variant { Err = variant { TokenPairAmmNotExist = record { amm = variant { "swap_v2_0.3%" }; pair = record { token0 = principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = principal "cngnf-vqaaa-aaaar-qag4q-cai"; }; } } }, )'
// test "pair_create" "$(dfx --identity default canister call swap pair_create "(record { pool=record{ token0=principal \"$token_ICP\"; token1=principal \"$token_ckUSDT\"; amm=\"swap_v2_0.3%\" }})" 2>&1)" '( variant { Ok = variant { swap_v2 = record { lp = variant { inner = record { fee = 10_000 : nat; decimals = 7 : nat8; dummy_canister_id = principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; minimum_liquidity = 10_000_000 : nat; total_supply = 0 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = 0 : nat64; reserve0 = "0"; reserve1 = "0"; subaccount = "81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996"; price1_cumulative_last = "0"; token0 = "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "0"; } } }, )'
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(5:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "create": { "creator": "'"$DEFAULT"'", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } } } ]'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(5:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(7:nat64)" --output json 2>&1)" '[ { "args": { "pair_create": { "arg": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "' '", "result": { "ok": "{\"swap_v2\":{\"subaccount\":\"81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996\",\"fee_rate\":\"3/1000\",\"token0\":\"ryjl3-tyaaa-aaaaa-aaaba-cai\",\"token1\":\"cngnf-vqaaa-aaaar-qag4q-cai\",\"reserve0\":\"0\",\"reserve1\":\"0\",\"block_timestamp_last\":0,\"price_cumulative_exponent\":64,\"price0_cumulative_last\":\"0\",'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(7:nat64)" --output json 2>&1)" '\"price1_cumulative_last\":\"0\",\"k_last\":\"0\",\"lp\":{\"inner\":{\"dummy_canister_id\":\"kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk\",\"total_supply\":[],\"decimals\":7,\"fee\":[10000],\"minimum_liquidity\":[10000000]}},\"protocol_fee\":\"1/6\"}}" } } ], "index": "7", "locks": { "balances": [], "swap": [ true ], "token": [] }, "traces": [ { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(7:nat64)" --output json 2>&1)" '", "1": "*TokenPairCreate* `token0:[ryjl3-tyaaa-aaaaa-aaaba-cai], token1:[cngnf-vqaaa-aaaar-qag4q-cai], amm:swap_v2_0.3%, subaccount:(81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), dummyCanisterId:[kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk]`" } ] } ]'
// test "pair_query" "$(dfx --identity alice canister call swap pair_query "(record { token0 = principal \"$token_ICP\"; token1 = principal \"$token_ckUSDT\"; amm = \"swap_v2_0.3%\"; })" >&1)" '( opt variant { swap_v2 = record { lp = variant { inner = record { fee = 10_000 : nat; decimals = 7 : nat8; dummy_canister_id = principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; minimum_liquidity = 10_000_000 : nat; total_supply = 0 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = 0 : nat64; reserve0 = "0"; reserve1 = "0"; subaccount = "81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996"; price1_cumulative_last = "0"; token0 = "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "0"; } }, )'
// token_ICP_token_ckUSDT_subaccount="\81\c0\9f\0a\bb\db\ab\8a\d4\06\10\7d\b3\d1\85\88\b6\67\eb\94\f3\be\6a\55\6c\e3\6b\88\75\cb\89\96"
// test "pair_swap_exact_tokens_for_tokens" "$(dfx --identity default canister call swap pair_swap_exact_tokens_for_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_in=100_000_000:nat; amount_out_min=100_000_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '( variant { Err = variant { InsufficientBalance = record { token = principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; balance = 0 : nat; } } }, )'
// test "icrc2_approve token_ICP/default" "$(dfx --identity default canister call token_ICP icrc2_approve "(record { spender=record{owner=principal \"$swap\";}; amount=100_000_000_000:nat })" 2>&1)" '(variant { Ok = 1 : nat })'
// test "token_deposit" "$(dfx --identity default canister call swap token_deposit "(record { token=principal \"$token_ICP\"; from=record{owner=principal \"$DEFAULT\"; subaccount=null}; deposit_amount_without_fee=20_000_000_000: nat; to=record{owner=principal \"$DEFAULT\"; subaccount=null}; }, null)" 2>&1)" '(variant { Ok = 2 : nat })'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(10:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "20_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(10:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(8:nat64)" --output json 2>&1)" '[ { "args": { "token_deposit": { "arg": { "amount": "20_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "' '", "result": { "ok": "2" } } ], "index": "8", "locks": { "balances": [ [ { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } ] ], "swap": [], "token": [ true ] }, "traces": [ { "0": "' '", "1": "*Deposit* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:('"$DEFAULT"'.), to:('"$DEFAULT"'.), amount:20_000_000_000, height:2`" }, { "0": "' '", "1": "Deposit Done." } ] } ]'
// test "pair_swap_exact_tokens_for_tokens" "$(dfx --identity default canister call swap pair_swap_exact_tokens_for_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_in=100_000_000:nat; amount_out_min=100_000_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '(variant { Err = variant { Swap = "INSUFFICIENT_LIQUIDITY" } })'
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\";                                  subaccount=null})" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 20_000_000_000 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 600_000_000_000 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 0 : nat;}'
// test "tokens_balance_of pool" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$swap\"; subaccount=opt blob \"$token_ICP_token_ckUSDT_subaccount\" })" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 0 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 0 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 0 : nat;}'
// test "pair_liquidity_add" "$(dfx --identity default canister call swap pair_liquidity_add "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token=record{ principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\" }; amount_desired=record{10_000_000_000:nat;200_000_000_000:nat}; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '( variant { Ok = record { liquidity = 44_721_359_549 : nat; amount = record { 10_000_000_000 : nat; 200_000_000_000 : nat }; } }, )'
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(6:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint": { "amount": "44_721_359_549", "amount0": "10_000_000_000", "amount1": "200_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk", "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(7:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "0", "price1_cumulative": "0", "price_cumulative_exponent": 64, "reserve0": "10_000_000_000", "reserve1": "200_000_000_000", "supply": "44_721_359_549" } } } } } } ]'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(6:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(9:nat64)" --output json 2>&1)" '[ { "args": { "pair_liquidity_add": { "arg": { "amount_a_desired": "10_000_000_000", "amount_a_min": "1", "amount_b_desired": "200_000_000_000", "amount_b_min": "1", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "self_canister": "piwiu-wiaaa-aaaaj-azzka-cai", "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "' '", "result": { "ok": "{\"amount\":[\"10_000_000_000\",\"200_000_000_000\"],\"liquidity\":\"44_721_359_549\"}" } } ], "index": "9", "locks": { "balances": [ [ { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(9:nat64)" --output json 2>&1)" '"subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } ] ], "swap": [ true ], "token": [ true ] }, "traces": [ { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(9:nat64)" --output json 2>&1)" '", "1": "*PairLiquidityAdd* `tokenA:[ryjl3-tyaaa-aaaaa-aaaba-cai], tokenB:[cngnf-vqaaa-aaaar-qag4q-cai], amm:swap_v2_0.3%, required: 1 <= amount_a <= 10_000_000_000 && 1 <= amount_b <= 200_000_000_000`" }, { "0": "' '", "1": "*PairLiquidityAdd* `amount_a:10_000_000_000, amount_b:200_000_000_000`" }, { "0": "' '", "1": "*TokenTransfer* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), amount:10_000_000_000, done:10_000_000_000`" }, { "0": "' '", "1": "*TokenTransfer* `token:[cngnf-vqaaa-aaaar-qag4q-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), amount:200_000_000_000, done:200_000_000_000`" }, { "0": "' '", "1": "*PairLiquidityMint(Deposit)* `token:[kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk], from[transferred 2 tokens]:('"$DEFAULT"'.), to[minted liquidity]:('"$DEFAULT"'.), amount:44_721_359_549`" }, { "0": "' '", "1": "*PairLiquidityMint* `token:[kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk], to:('"$DEFAULT"'.), amount:44_721_359_549`" }, { "0": "' '", "1": "Token Pair Add Liquidity Done." } ] } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(11:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "10_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(12:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "200_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(13:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "44_721_359_549", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk" } } } } ]'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(11:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(12:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(13:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\";                                   subaccount=null})" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 10_000_000_000 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 400_000_000_000 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 44_721_359_549 : nat;}'
// test "tokens_balance_of pool" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$swap\"; subaccount=opt blob \"$token_ICP_token_ckUSDT_subaccount\" })" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 10_000_000_000 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 200_000_000_000 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 0 : nat;}'
// test "pair_swap_exact_tokens_for_tokens" "$(dfx --identity default canister call swap pair_swap_exact_tokens_for_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_in=100_000_000:nat; amount_out_min=100_000_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '( variant { Err = variant { Swap = "INSUFFICIENT_OUTPUT_AMOUNT: 1_974_316_068" } }, )'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(10:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(14:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(8:nat64)" --output json 2>&1)" 'invalid block height'
// start_time_s0=$(date +%s)
// test "pair_swap_exact_tokens_for_tokens" "$(dfx --identity default canister call swap pair_swap_exact_tokens_for_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_in=100_000_000:nat; amount_out_min=1_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '( variant { Ok = record { amounts = vec { 100_000_000 : nat; 1_974_316_068 : nat } } }, )'
// end_time_s0=$(date +%s)
// spend=$(($end_time_s0 - $start_time_s0))
// echo "pair_swap_exact_tokens_for_tokens Total: $spend seconds"
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(8:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "100_000_000", "amount_b": "1_974_316_068", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(9:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_100_000_000", "reserve1": "198_025_683_932", "supply": "44_721_359_549" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(10:nat64)" 2>&1)" '(null)'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(8:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(9:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(10:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(14:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "100_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(15:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_974_316_068", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(16:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(14:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(15:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(16:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(10:nat64)" --output json 2>&1)" '[ { "args": { "pair_swap_exact_tokens_for_tokens": { "arg": { "amount_in": "100_000_000", "amount_out_min": "1_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pas": [ { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } ], "path": [ { "amm": "swap_v2_0.3%", "token": { "0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "1": "cngnf-vqaaa-aaaar-qag4q-cai" } } ], "self_canister": "piwiu-wiaaa-aaaaj-azzka-cai", "to": { "owner": "'"$DEFAULT"'", "subaccount": [] } }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(10:nat64)" --output json 2>&1)" '", "result": { "ok": "{\"amounts\":[\"100_000_000\",\"1_974_316_068\"]}" } } ], "index": "10", "locks": { "balances": [ [ { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(10:nat64)" --output json 2>&1)" '"token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } ] ], "swap": [ true ], "token": [ true ] }, "traces": [ { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(10:nat64)" --output json 2>&1)" '", "1": "*TokenTransfer* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), amount:100_000_000, done:100_000_000`" }, { "0": "' '", "1": "*TokenTransfer* `token:[cngnf-vqaaa-aaaar-qag4q-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), to:('"$DEFAULT"'.), amount:1_974_316_068, done:1_974_316_068`" }, { "0": "' '", "1": "*SwapV2State* `pa:([ryjl3-tyaaa-aaaaa-aaaba-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), timestamp:' ', exponent:64, price0_cumulative:' ', price1_cumulative:' '`" }, { "0": "' '", "1": "*TokenPairSwap* `swap_pair:([ryjl3-tyaaa-aaaaa-aaaba-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), from:('"$DEFAULT"'.), to:('"$DEFAULT"'.), pay_amount:100_000_000, got_amount:1_974_316_068`" }, { "0": "' '", "1": "Token Pair Swap Exact Tokens for Tokens Done." } ] } ]'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(11:nat64)" 2>&1)" '(null)'
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\";                                  subaccount=null})" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 9_900_000_000 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 401_974_316_068 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 44_721_359_549 : nat;}'
// test "tokens_balance_of pool" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$swap\"; subaccount=opt blob \"$token_ICP_token_ckUSDT_subaccount\" })" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 10_100_000_000 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 198_025_683_932 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 0 : nat;}'
// test "pair_query" "$(dfx --identity alice canister call swap pair_query "(record { token0 = principal \"$token_ICP\"; token1 = principal \"$token_ckUSDT\"; amm = \"swap_v2_0.3%\"; })" >&1)" '( opt variant { swap_v2 = record { lp = variant { inner = record { fee = 10_000 : nat; decimals = 7 : nat8; dummy_canister_id = principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; minimum_liquidity = 10_000_000 : nat; total_supply = 44_721_359_549 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = ' ' : nat64; reserve0 = "10_100_000_000"; reserve1 = "198_025_683_932"; subaccount = "81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996"; price1_cumulative_last = "' '"; token0 = "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "' '"; } }, )'

// blue "\n🚩 2.4 business pair swap tokens for extra tokens"
// test "pair_swap_tokens_for_exact_tokens" "$(dfx --identity default canister call swap pair_swap_tokens_for_exact_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_out=25_683_932:nat; amount_in_max=1_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '(variant { Err = variant { Swap = "EXCESSIVE_INPUT_AMOUNT: 1_314_083" } })'
// test "pair_swap_tokens_for_exact_tokens" "$(dfx --identity default canister call swap pair_swap_tokens_for_exact_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_out=25_683_932:nat; amount_in_max=1_314_082:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '(variant { Err = variant { Swap = "EXCESSIVE_INPUT_AMOUNT: 1_314_083" } })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(12:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(16:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(10:nat64)" --output json 2>&1)" 'invalid block height'
// start_time_s0=$(date +%s)
// test "pair_swap_tokens_for_exact_tokens" "$(dfx --identity default canister call swap pair_swap_tokens_for_exact_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_out=25_683_932:nat; amount_in_max=1_314_083:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '( variant { Ok = record { amounts = vec { 1_314_083 : nat; 25_683_932 : nat } } }, )'
// end_time_s0=$(date +%s)
// spend=$(($end_time_s0 - $start_time_s0))
// echo "pair_swap_tokens_for_exact_tokens Total: $spend seconds"
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block --output json "(10:nat64)" 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "1_314_083", "amount_b": "25_683_932", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block --output json "(11:nat64)" 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_101_314_083", "reserve1": "198_000_000_000", "supply": "44_721_359_549" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(12:nat64)" 2>&1)" '(null)'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(10:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(11:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(12:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(16:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_314_083", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(17:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "25_683_932", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(18:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(16:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(17:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(18:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(11:nat64)" --output json 2>&1)" '[ { "args": { "pair_swap_tokens_for_exact_tokens": { "arg": { "amount_in_max": "1_314_083", "amount_out": "25_683_932", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pas": [ { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } ], "path": [ { "amm": "swap_v2_0.3%", "token": { "0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "1": "cngnf-vqaaa-aaaar-qag4q-cai" } } ], "self_canister": "piwiu-wiaaa-aaaaj-azzka-cai", "to": { "owner": "'"$DEFAULT"'", "subaccount": [] } }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "' '", "result": { "ok": "{\"amounts\":[\"1_314_083\",\"25_683_932\"]}" } } ], "index": "11", "locks": { "balances": [ [ { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(11:nat64)" --output json 2>&1)" '[ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } ] ], "swap": [ true ], "token": [ true ] }, "traces": [ { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(11:nat64)" --output json 2>&1)" '", "1": "*TokenTransfer* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), amount:1_314_083, done:1_314_083`" }, { "0": "' '", "1": "*TokenTransfer* `token:[cngnf-vqaaa-aaaar-qag4q-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), to:('"$DEFAULT"'.), amount:25_683_932, done:25_683_932`" }, { "0": "' '", "1": "*SwapV2State* `pa:([ryjl3-tyaaa-aaaaa-aaaba-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), timestamp:' ', exponent:64, price0_cumulative:' ', price1_cumulative:' '`" }, { "0": "' '", "1": "*TokenPairSwap* `swap_pair:([ryjl3-tyaaa-aaaaa-aaaba-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), from:('"$DEFAULT"'.), to:('"$DEFAULT"'.), pay_amount:1_314_083, got_amount:25_683_932`" }, { "0": "' '", "1": "Token Pair Swap Tokens for Exact Tokens Done." } ] } ]'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(12:nat64)" 2>&1)" '(null)'
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\";                                  subaccount=null})" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 9_898_685_917 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 402_000_000_000 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 44_721_359_549 : nat;}'
// test "tokens_balance_of pool" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$swap\"; subaccount=opt blob \"$token_ICP_token_ckUSDT_subaccount\" })" 2>&1)" 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 10_101_314_083 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 198_000_000_000 : nat;}' 'record { principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; 0 : nat;}'
// test "pair_query" "$(dfx --identity alice canister call swap pair_query "(record { token0 = principal \"$token_ICP\"; token1 = principal \"$token_ckUSDT\"; amm = \"swap_v2_0.3%\"; })" >&1)" '( opt variant { swap_v2 = record { lp = variant { inner = record { fee = 10_000 : nat; decimals = 7 : nat8; dummy_canister_id = principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; minimum_liquidity = 10_000_000 : nat; total_supply = 44_721_359_549 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = ' ' : nat64; reserve0 = "10_101_314_083"; reserve1 = "198_000_000_000"; subaccount = "81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996"; price1_cumulative_last = "' '"; token0 = "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "' '"; } }, )'

// blue "\n🚩 2.5 business pair swap by loan"
// test "pairs_query" "$(dfx --identity alice canister call swap pairs_query >&1)" '( vec { record { record { amm = "swap_v2_0.3%"; token0 = principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = principal "cngnf-vqaaa-aaaar-qag4q-cai"; }; variant { swap_v2 = record { lp = variant { inner = record { fee = 10_000 : nat; decimals = 7 : nat8; dummy_canister_id = principal "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk"; minimum_liquidity = 10_000_000 : nat; total_supply = 44_721_359_549 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = ' ' : nat64; reserve0 = "10_101_314_083"; reserve1 = "198_000_000_000"; subaccount = "81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996"; price1_cumulative_last = "' '"; token0 = "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "'
// test "pairs_query" "$(dfx --identity alice canister call swap pairs_query >&1)" '"; } }; }; record { record { amm = "swap_v2_0.3%"; token0 = principal "ss2fx-dyaaa-aaaar-qacoq-cai"; token1 = principal "cngnf-vqaaa-aaaar-qag4q-cai"; }; variant { swap_v2 = record { lp = variant { inner = record { fee = 100_000_000 : nat; decimals = 12 : nat8; dummy_canister_id = principal "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4"; minimum_liquidity = 100_000_000_000 : nat; total_supply = 447_213_595_499_957 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = ' ' : nat64; reserve0 = "999_999_999_999_998_882"; reserve1 = "200_000_000_000"; subaccount = "11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c"; price1_cumulative_last = "' '"; token0 = "ss2fx-dyaaa-aaaar-qacoq-cai"; token1 = "cngnf-vqaaa-aaaar-qag4q-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "' '"; } }; }; }, )'
// # ICP -> USDT 10_101_314_083 -> 198_000_000_000
// # USDT -> ETH 200_000_000_000 -> 999_999_999_999_998_882
// test "pair_create" "$(dfx --identity default canister call swap pair_create "(record { pool=record{ token0=principal \"$token_ICP\"; token1=principal \"$token_ckETH\"; amm=\"swap_v2_0.3%\"} })" 2>&1)" '( variant { Ok = variant { swap_v2 = record { lp = variant { inner = record { fee = 100_000_000 : nat; decimals = 13 : nat8; dummy_canister_id = principal "3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy"; minimum_liquidity = 100_000_000_000 : nat; total_supply = 0 : nat; } }; price_cumulative_exponent = 64 : nat8; block_timestamp_last = 0 : nat64; reserve0 = "0"; reserve1 = "0"; subaccount = "820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425"; price1_cumulative_last = "0"; token0 = "ryjl3-tyaaa-aaaaa-aaaba-cai"; token1 = "ss2fx-dyaaa-aaaar-qacoq-cai"; fee_rate = "3/1000"; k_last = "0"; protocol_fee = opt "1/6"; price0_cumulative_last = "0"; } } }, )'
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(12:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "create": { "creator": "'"$DEFAULT"'", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } } } } ]'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(12:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(12:nat64)" --output json 2>&1)" '[ { "args": { "pair_create": { "arg": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "' '", "result": { "ok": "{\"swap_v2\":{\"subaccount\":\"820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425\",\"fee_rate\":\"3/1000\",\"token0\":\"ryjl3-tyaaa-aaaaa-aaaba-cai\",\"token1\":\"ss2fx-dyaaa-aaaar-qacoq-cai\",\"reserve0\":\"0\",\"reserve1\":\"0\",\"block_timestamp_last\":0,\"price_cumulative_exponent\":64,\"price0_cumulative_last\":\"0\",\"price1_cumulative_last\":\"0\",\"k_last\":\"0\",\"lp\":{\"inner\":{\"dummy_canister_id\":\"3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy\",\"total_supply\":[],'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(12:nat64)" --output json 2>&1)" '\"decimals\":13,\"fee\":[100000000],\"minimum_liquidity\":[1215752192,23]}},\"protocol_fee\":\"1/6\"}}" } } ], "index": "12", "locks": { "balances": [], "swap": [ true ], "token": [] }, "traces": [ { "0": "' '", "1": "*TokenPairCreate* `token0:[ryjl3-tyaaa-aaaaa-aaaba-cai], token1:[ss2fx-dyaaa-aaaar-qacoq-cai], amm:swap_v2_0.3%, subaccount:(820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425), dummyCanisterId:[3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy]`" } ] } ]'
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\"; subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 2_000_000_000_000_001_118 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 402_000_000_000 : nat;}' 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 9_898_685_917 : nat;}'
// test "pair_liquidity_add" "$(dfx --identity default canister call swap pair_liquidity_add "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token=record{ principal \"$token_ICP\"; principal \"$token_ckETH\"}; amm=\"swap_v2_0.3%\" }; amount_desired=record{2_000_000_000:nat;100_000_000_000_000_000:nat}; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '( variant { Ok = record { liquidity = 14_142_135_623_730 : nat; amount = record { 2_000_000_000 : nat; 100_000_000_000_000_000 : nat }; } }, )'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(18:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "2_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(19:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "100_000_000_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(20:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "14_142_135_623_730", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy" } } } } ]'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(18:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(19:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(20:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(13:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint": { "amount": "14_142_135_623_730", "amount0": "2_000_000_000", "amount1": "100_000_000_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy", "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(14:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "price0_cumulative": "0", "price1_cumulative": "0", "price_cumulative_exponent": 64, "reserve0": "2_000_000_000", "reserve1": "100_000_000_000_000_000", "supply": "14_142_135_623_730" } } } } } } ]'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(13:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(14:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(13:nat64)" --output json 2>&1)" '[ { "args": { "pair_liquidity_add": { "arg": { "amount_a_desired": "2_000_000_000", "amount_a_min": "1", "amount_b_desired": "100_000_000_000_000_000", "amount_b_min": "1", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "self_canister": "piwiu-wiaaa-aaaaj-azzka-cai", "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "ss2fx-dyaaa-aaaar-qacoq-cai" }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "' '", "result": { "ok": "{\"amount\":[\"2_000_000_000\",\"100_000_000_000_000_000\"],\"liquidity\":\"14_142_135_623_730\"}" } } ], "index": "13", "locks": { "balances": [ [ { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(13:nat64)" --output json 2>&1)" '"token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } ] ], "swap": [ true ], "token": [ true ] }, "traces": [ { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(13:nat64)" --output json 2>&1)" '", "1": "*PairLiquidityAdd* `tokenA:[ryjl3-tyaaa-aaaaa-aaaba-cai], tokenB:[ss2fx-dyaaa-aaaar-qacoq-cai], amm:swap_v2_0.3%, required: 1 <= amount_a <= 2_000_000_000 && 1 <= amount_b <= 100_000_000_000_000_000`" }, { "0": "' '", "1": "*PairLiquidityAdd* `amount_a:2_000_000_000, amount_b:100_000_000_000_000_000`" }, { "0": "' '", "1": "*TokenTransfer* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425), amount:2_000_000_000, done:2_000_000_000`" }, { "0": "' '", "1": "*TokenTransfer* `token:[ss2fx-dyaaa-aaaar-qacoq-cai], from:('"$DEFAULT"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425), amount:100_000_000_000_000_000, done:100_000_000_000_000_000`" }, { "0": "' '", "1": "*PairLiquidityMint(Deposit)* `token:[3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy], from[transferred 2 tokens]:('"$DEFAULT"'.), to[minted liquidity]:('"$DEFAULT"'.), amount:14_142_135_623_730`" }, { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(13:nat64)" --output json 2>&1)" '", "1": "*PairLiquidityMint* `token:[3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy], to:('"$DEFAULT"'.), amount:14_142_135_623_730`" }, { "0": "' '", "1": "Token Pair Add Liquidity Done." } ] } ]'
// # ETH -> ICP 100_000_000_000_000_000 -> 20_000_000_000
// test "tokens_balance_of user default" "$(dfx --identity default canister call swap tokens_balance_of "(record { owner=principal \"$DEFAULT\"; subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 1_900_000_000_000_001_118 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 402_000_000_000 : nat;}' 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 7_898_685_917 : nat;}'
// test "tokens_balance_of user bob    " "$(dfx --identity bob canister call swap tokens_balance_of "(record { owner=principal \"$BOB\";         subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 0 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 0 : nat;}' 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 0 : nat;}'
// test "pair_swap_by_loan" "$(dfx --identity default canister call swap pair_swap_by_loan "( record {from=record{owner=principal \"$DEFAULT\"}; loan=2_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"}; record {token=record{principal \"$token_ckUSDT\"; principal \"$token_ckETH\"}; amm=\"swap_v2_0.3%\"}; record {token=record{principal \"$token_ckETH\"; principal \"$token_ICP\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$BOB\"}; deadline=null} , null)" 2>&1)" '( variant { Err = variant { Swap = "INSUFFICIENT_OUTPUT_AMOUNT: 1_165_021_595" } }, )'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(15:nat64)" 2>&1)" '(null)'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(21:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(21:nat64)" --output json 2>&1)" 'invalid block height'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(15:nat64)" 2>&1)" '(null)'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(15:nat64)" --output json 2>&1)" 'invalid block height'
// start_time_s0=$(date +%s)
// test "pair_swap_by_loan" "$(dfx --identity default canister call swap pair_swap_by_loan "( record {from=record{owner=principal \"$DEFAULT\"}; loan=20_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"}; record {token=record{principal \"$token_ckUSDT\"; principal \"$token_ckETH\"}; amm=\"swap_v2_0.3%\"}; record {token=record{principal \"$token_ckETH\"; principal \"$token_ICP\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$BOB\"}; deadline=null} , null)" 2>&1)" '( variant { Ok = record { amounts = vec { 20_000 : nat; 390_851 : nat; 1_948_388_438_775 : nat; 38_850 : nat; }; } }, )'
// end_time_s0=$(date +%s)
// spend=$(($end_time_s0 - $start_time_s0))
// echo "pair_swap_by_loan Total: $spend seconds"
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(15:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "20_000", "amount_b": "390_851", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(16:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_101_334_083", "reserve1": "197_999_609_149", "supply": "44_721_359_549" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(17:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "390_851", "amount_b": "1_948_388_438_775", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token_a": "cngnf-vqaaa-aaaar-qag4q-cai", "token_b": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(18:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "999_998_051_611_560_107", "reserve1": "200_000_390_851", "supply": "447_213_595_499_957" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(19:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "1_948_388_438_775", "amount_b": "38_850", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "to": { "owner": "'"$BOB"'", "subaccount": [] }, "token_a": "ss2fx-dyaaa-aaaar-qacoq-cai", "token_b": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(20:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "1_999_961_150", "reserve1": "100_001_948_388_438_775", "supply": "14_142_135_623_730" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(21:nat64)" 2>&1)" '(null)'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(15:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(16:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(17:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(18:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(19:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(20:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(21:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(21:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "20_000", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(22:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "390_851", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(23:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_948_388_438_775", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(24:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "38_850", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "to": { "owner": "'"$BOB"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(25:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "20_000", "from": { "owner": "'"$BOB"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } ]'
// test "👁︎ get_token_block" "$(dfx --identity default canister call $archive_token get_block "(26:nat64)" 2>&1)" '(null)'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(21:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(22:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(23:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(24:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(25:nat64)" 2>&1)" '(variant { archive = principal "ykio2-paaaa-aaaaj-az5ka-cai" })'
// test "👁︎ block_token_get" "$(dfx --identity default canister call swap block_token_get "(26:nat64)" 2>&1)" 'invalid block height'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(14:nat64)" --output json 2>&1)" '[ { "args": { "pair_swap_by_loan": { "arg": { "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "loan": "20_000", "pas": [ { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } } ], "path": [ { "amm": "swap_v2_0.3%", "token": { "0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, { "amm": "swap_v2_0.3%", "token": { "0": "cngnf-vqaaa-aaaar-qag4q-cai", "1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, { "amm": "swap_v2_0.3%", "token": { "0": "ss2fx-dyaaa-aaaar-qacoq-cai", "1": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } ], "self_canister": "piwiu-wiaaa-aaaaj-azzka-cai", "to": { "owner": "'"$BOB"'", "subaccount": [] } }, "caller": "'"$DEFAULT"'", "created": [], "memo": [], "now": "' '" } }, "created": "' '", "done": [ { "done": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(14:nat64)" --output json 2>&1)" '", "result": { "ok": "{\"amounts\":[\"20_000\",\"390_851\",\"1_948_388_438_775\",\"38_850\"]}" } } ], "index": "14", "locks": { "balances": [ [ { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(14:nat64)" --output json 2>&1)" '"subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" }, { "account": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": '
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(14:nat64)" --output json 2>&1)" '[ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" }, { "account": { "owner": "'"$BOB"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } ] ], "swap": [ true ], "token": [ true ] }, "traces": [ { "0": "' '", "1": "*TokenLoan* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.), to:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), amount:20_000`" }, { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(14:nat64)" --output json 2>&1)" '", "1": "*TokenTransfer* `token:[cngnf-vqaaa-aaaar-qag4q-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.81c09f0abbdbab8ad406107db3d18588b667eb94f3be6a556ce36b8875cb8996), to:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), amount:390_851, done:390_851`" }, { "0": "' '", "1": "*SwapV2State* `pa:([ryjl3-tyaaa-aaaaa-aaaba-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), timestamp:' ', exponent:64, price0_cumulative:' ', price1_cumulative:' '`" }, { "0": "' '", "1": "*TokenPairSwap* `swap_pair:([ryjl3-tyaaa-aaaaa-aaaba-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), from:(piwiu-wiaaa-aaaaj-azzka-cai.), to:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), pay_amount:20_000, got_amount:390_851`" }, { "0": "' '", "1": "*TokenTransfer* `token:[ss2fx-dyaaa-aaaar-qacoq-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), to:(piwiu-wiaaa-aaaaj-azzka-cai.820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425), amount:1_948_388_438_775, done:1_948_388_438_775`" }, { "0": "' '", "1": "*SwapV2State* `pa:([ss2fx-dyaaa-aaaar-qacoq-cai],[cngnf-vqaaa-aaaar-qag4q-cai],swap_v2_0.3%), timestamp:'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(14:nat64)" --output json 2>&1)" ', exponent:64, price0_cumulative:' ', price1_cumulative:' '`" }, { "0": "' '", "1": "*TokenPairSwap* `swap_pair:([cngnf-vqaaa-aaaar-qag4q-cai],[ss2fx-dyaaa-aaaar-qacoq-cai],swap_v2_0.3%), from:(piwiu-wiaaa-aaaaj-azzka-cai.11dffa35fd42810f9b249c39749d4adc73a397f799f90703bf6d8fcc1ef7d92c), to:(piwiu-wiaaa-aaaaj-azzka-cai.820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425), pay_amount:390_851, got_amount:1_948_388_438_775`" }, { "0": "' '", "1": "*TokenTransfer* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:(piwiu-wiaaa-aaaaj-azzka-cai.820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425), to:('"$BOB"'.), amount:38_850, done:38_850`" }, { "0": "'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(14:nat64)" --output json 2>&1)" '", "1": "*SwapV2State* `pa:([ryjl3-tyaaa-aaaaa-aaaba-cai],[ss2fx-dyaaa-aaaar-qacoq-cai],swap_v2_0.3%), timestamp:' ', exponent:64, price0_cumulative:' ', price1_cumulative:' '`" }, { "0": "' '", "1": "*TokenPairSwap* `swap_pair:([ss2fx-dyaaa-aaaar-qacoq-cai],[ryjl3-tyaaa-aaaaa-aaaba-cai],swap_v2_0.3%), from:(piwiu-wiaaa-aaaaj-azzka-cai.820bfbb786d1714160fab4dffc7ae7580ef6fd2dfacbaba89a38424ecc84a425), to:('"$BOB"'.), pay_amount:1_948_388_438_775, got_amount:38_850`" }, { "0": "' '", "1": "*TokenRepay* `token:[ryjl3-tyaaa-aaaaa-aaaba-cai], from:('"$BOB"'.), to:(piwiu-wiaaa-aaaaj-azzka-cai.), amount:20_000`" }, { "0": "' '", "1": "Token Pair Swap by Loan Done." } ] } ]'
// test "👁︎ request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(15:nat64)" 2>&1)" '(null)'
// test "tokens_balance_of user bob    " "$(dfx --identity bob canister call swap tokens_balance_of "(record { owner=principal \"$BOB\";         subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 0 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 0 : nat;}' 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 18_850 : nat;}'

// blue "\n🚩 2.6 business pair swap with deposit and withdraw"
// test "pair_swap_with_deposit_and_withdraw" "$(dfx --identity default canister call swap pair_swap_with_deposit_and_withdraw "( record {from=record{owner=principal \"$DEFAULT\"}; deposit_amount_without_fee=20_000_000_000_000:nat; amount_out_min=20_000_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null})" 2>&1)" '( variant { Err = variant { Swap = "INSUFFICIENT_OUTPUT_AMOUNT: 197_899_356_014" } }, null, null, )'
// test "pair_swap_with_deposit_and_withdraw" "$(dfx --identity default canister call swap pair_swap_with_deposit_and_withdraw "( record {from=record{owner=principal \"$DEFAULT\"}; deposit_amount_without_fee=2_000_000_000:nat; amount_out_min=20_000_000_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null})" 2>&1)" '( variant { Err = variant { Swap = "INSUFFICIENT_OUTPUT_AMOUNT: 32_641_613_529" } }, null, null, )'
// test "pair_swap_with_deposit_and_withdraw" "$(dfx --identity default canister call swap pair_swap_with_deposit_and_withdraw "( record {from=record{owner=principal \"$DEFAULT\"}; deposit_amount_without_fee=20_000_000_000_000:nat; amount_out_min=20_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null})" 2>&1)" '( variant { Err = variant { TransferFromError = variant { InsufficientAllowance = record { allowance = 79_999_990_000 : nat } } } }, null, null, )'
// test "icrc1_balance_of ICP/default" "$(dfx --identity default canister call token_ICP icrc1_balance_of "(record{owner=principal \"$DEFAULT\"})" 2>&1)" '(979_999_980_000 : nat)'
// test "icrc1_balance_of ckUSDT/default" "$(dfx --identity default canister call token_ckUSDT icrc1_balance_of "(record{owner=principal \"$DEFAULT\"})" 2>&1)" '(99_199_999_980_000 : nat)'
// start_time_s0=$(date +%s)
// test "pair_swap_with_deposit_and_withdraw" "$(dfx --identity default canister call swap pair_swap_with_deposit_and_withdraw "( record {from=record{owner=principal \"$DEFAULT\"}; deposit_amount_without_fee=200_000_000:nat; amount_out_min=20_000_000:nat; path=vec { record {token=record{principal \"$token_ICP\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null})" 2>&1)" '( variant { Ok = 3 : nat }, opt variant { Ok = record { amounts = vec { 200_000_000 : nat; 3_832_845_479 : nat } } }, opt variant { Ok = 3 : nat }, )'
// end_time_s0=$(date +%s)
// spend=$(($end_time_s0 - $start_time_s0))
// echo "pair_swap_by_loan Total: $spend seconds"
// sleep 2
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(21:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "200_000_000", "amount_b": "3_832_845_479", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(22:nat64)" --output json 2>&1)" '[ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_301_334_083", "reserve1": "194_166_763_670", "supply": "44_721_359_549" } } } } } } ]'
// test "👁︎ get_swap_block" "$(dfx --identity default canister call $archive_swap get_block "(23:nat64)" 2>&1)" '(null)'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(21:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(22:nat64)" 2>&1)" '(variant { archive = principal "hcnys-xiaaa-aaaai-q3w4q-cai" })'
// test "👁︎ block_swap_get" "$(dfx --identity default canister call swap block_swap_get "(23:nat64)" 2>&1)" 'invalid block height'
// test "icrc1_balance_of ICP/default" "$(dfx --identity default canister call token_ICP icrc1_balance_of "(record{owner=principal \"$DEFAULT\"})" 2>&1)" '(979_799_970_000 : nat)'
// test "icrc1_balance_of ckUSDT/default" "$(dfx --identity default canister call token_ckUSDT icrc1_balance_of "(record{owner=principal \"$DEFAULT\"})" 2>&1)" '(99_203_832_815_479 : nat)'

// blue "\n🚩 3 business config fee to"
// blue "\n🚩 3.1 business config fee to update"
// test "🙈 config_fee_to_query" "$(dfx --identity bob canister call swap config_fee_to_query 2>&1)" "Permission 'BusinessConfigFeeTo' is required"
// test "config_fee_to_query" "$(dfx --identity default canister call swap config_fee_to_query 2>&1)" '(record { token_fee_to = null; swap_fee_to = null })'
// test "❎ config_fee_to_replace" "$(dfx --identity bob canister call swap config_fee_to_replace "(record {token_fee_to=opt record{owner=principal \"$ALICE\"}; swap_fee_to=opt record{owner=principal \"$BOB\"}})" 2>&1)" "Permission 'BusinessConfigFeeTo' is required"
// test "config_fee_to_replace" "$(dfx --identity default canister call swap config_fee_to_replace "(record {token_fee_to=opt record{owner=principal \"$ALICE\"}; swap_fee_to=opt record{owner=principal \"$BOB\"}})" 2>&1)" '(record { token_fee_to = null; swap_fee_to = null })'
// test "config_fee_to_query" "$(dfx --identity default canister call swap config_fee_to_query 2>&1)" '( record { token_fee_to = opt record { owner = principal "'"$ALICE"'"; subaccount = null; }; swap_fee_to = opt record { owner = principal "'"$BOB"'"; subaccount = null; }; }, )'

// blue "\n🚩 3.2 business config fee to effect"
// test "token_balance_of user default" "$(dfx --identity default canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$DEFAULT\"})" 2>&1)" '(447_213_595_499_957 : nat)'
// test "token_balance_of user bob" "$(dfx --identity bob canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$BOB\"})" 2>&1)" '(0 : nat)'
// # liquidity changed after set fee_to
// test "pair_liquidity_remove" "$(dfx --identity default canister call swap pair_liquidity_remove "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; liquidity_without_fee=1_000_000:nat; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '(variant { Ok = record { amount = record { 2_236_063_620 : nat; 447 : nat } } })'
// test "token_balance_of user default" "$(dfx --identity default canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$DEFAULT\"})" 2>&1)" '(447_213_494_499_957 : nat)'
// test "token_balance_of user bob" "$(dfx --identity bob canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$BOB\"})" 2>&1)" '(0 : nat)'
// # do swap
// test "pair_swap_exact_tokens_for_tokens" "$(dfx --identity default canister call swap pair_swap_exact_tokens_for_tokens "( record {from=record{owner=principal \"$DEFAULT\"}; amount_in=100_000_000_000:nat; amount_out_min=1:nat; path=vec { record {token=record{principal \"$token_ckETH\"; principal \"$token_ckUSDT\"}; amm=\"swap_v2_0.3%\"} }; to=record{owner=principal \"$DEFAULT\"}; deadline=null} , null)" 2>&1)" '( variant { Ok = record { amounts = vec { 100_000_000_000 : nat; 19_940 : nat } } }, )'
// test "token_balance_of user default" "$(dfx --identity default canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$DEFAULT\"})" 2>&1)" '(447_213_494_499_957 : nat)'
// test "token_balance_of user bob" "$(dfx --identity bob canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$BOB\"})" 2>&1)" '(0 : nat)'
// # liquidity changed after swap
// test "pair_liquidity_remove" "$(dfx --identity default canister call swap pair_liquidity_remove "(record { from=record{owner=principal\"$DEFAULT\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; liquidity_without_fee=1_000_000:nat; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$DEFAULT\"}; deadline=null } , null)" 2>&1)" '(variant { Ok = record { amount = record { 2_236_064_344 : nat; 447 : nat } } })'
// test "token_balance_of user default" "$(dfx --identity default canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$DEFAULT\"})" 2>&1)" '(447_213_393_499_957 : nat)'
// test "token_balance_of user bob" "$(dfx --identity bob canister call swap token_balance_of "(principal \"vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4\", record { owner=principal \"$BOB\"})" 2>&1)" '(11_194 : nat)'
// test "tokens_balance_of user bob    " "$(dfx --identity bob canister call swap tokens_balance_of "(record { owner=principal \"$BOB\";         subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 0 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 0 : nat;}' 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 18_850 : nat;}'
// test "pair_liquidity_remove" "$(dfx --identity bob canister call swap pair_liquidity_remove "(record { from=record{owner=principal\"$BOB\"}; swap_pair=record { token = record { principal \"$token_ckETH\"; principal \"$token_ckUSDT\" }; amm=\"swap_v2_0.3%\"; }; liquidity_without_fee=11_194:nat; amount_min=record{1:nat;1:nat}; to=record{owner=principal\"$BOB\"}; deadline=null } , null)" 2>&1)" '{ Err = variant { Liquidity = "INSUFFICIENT_LIQUIDITY" } })'
// test "tokens_balance_of user bob    " "$(dfx --identity bob canister call swap tokens_balance_of "(record { owner=principal \"$BOB\";         subaccount=null})" 2>&1)" 'record { principal "ss2fx-dyaaa-aaaar-qacoq-cai"; 0 : nat;}' 'record { principal "cngnf-vqaaa-aaaar-qag4q-cai"; 0 : nat;}' 'record { principal "ryjl3-tyaaa-aaaaa-aaaba-cai"; 18_850 : nat;}'

// blue "\n🚩 4.1 permission permission_query"
// test "version" "$(dfx --identity alice canister call swap version 2>&1)" '(1 : nat32)'
// test "permission_all" "$(dfx --identity alice canister call swap permission_all 2>&1)" 'vec { variant { Forbidden = "PauseQuery" }; variant { Permitted = "PauseReplace" }'
// test "permission_query" "$(dfx --identity alice canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PermissionQuery"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'
// test "permission_query" "$(dfx --identity default canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PauseReplace"; "PermissionQuery"; "PermissionFind"; "PermissionUpdate"; "ScheduleFind"; "ScheduleReplace"; "ScheduleTrigger"; "BusinessConfigFeeTo"; "BusinessConfigCustomToken"; "BusinessConfigMaintaining"; "BusinessTokenBalanceBy"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairCreateOrRemove"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap";}, )'
// test "permission_update" "$(dfx --identity bob canister call swap permission_update "(vec { variant { UpdateUserPermission=record{principal \"$ALICE\"; opt vec { \"PermissionUpdate\";\"PermissionQuery\" } } } })" 2>&1)" "'PermissionUpdate' is required"
// test "permission_update" "$(dfx --identity default canister call swap permission_update "(vec { variant { UpdateUserPermission=record{principal \"$ALICE\"; opt vec { \"PermissionUpdate\";\"PermissionQuery\" } } } })" 2>&1)" "()"
// test "🙈 permission_query" "$(dfx --identity alice canister call swap permission_query 2>&1)" "'PermissionQuery' is required"
// test "permission_query" "$(dfx --identity default canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PauseReplace"; "PermissionQuery"; "PermissionFind"; "PermissionUpdate"; "ScheduleFind"; "ScheduleReplace"; "ScheduleTrigger"; "BusinessConfigFeeTo"; "BusinessConfigCustomToken"; "BusinessConfigMaintaining"; "BusinessTokenBalanceBy"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairCreateOrRemove"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap";}, )'
// test "permission_find_by_user" "$(dfx --identity default canister call swap permission_find_by_user "(principal \"$ALICE\")" 2>&1)" '( vec { "PauseQuery"; "PermissionUpdate"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'
// test "permission_update" "$(dfx --identity alice canister call swap permission_update "(vec { variant { UpdateUserPermission=record{principal \"$ALICE\"; null } } })" 2>&1)" "()"
// test "permission_query" "$(dfx --identity alice canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PermissionQuery"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'
// test "permission_query" "$(dfx --identity default canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PauseReplace"; "PermissionQuery"; "PermissionFind"; "PermissionUpdate"; "ScheduleFind"; "ScheduleReplace"; "ScheduleTrigger"; "BusinessConfigFeeTo"; "BusinessConfigCustomToken"; "BusinessConfigMaintaining"; "BusinessTokenBalanceBy"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairCreateOrRemove"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap";}, )'

// blue "\n🚩 4.2 permission permission update"
// test "permission_query" "$(dfx --identity default canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PauseReplace"; "PermissionQuery"; "PermissionFind"; "PermissionUpdate"; "ScheduleFind"; "ScheduleReplace"; "ScheduleTrigger"; "BusinessConfigFeeTo"; "BusinessConfigCustomToken"; "BusinessConfigMaintaining"; "BusinessTokenBalanceBy"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairCreateOrRemove"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap";}, )'
// test "permission_query" "$(dfx --identity alice canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PermissionQuery"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'
// test "permission_find_by_user" "$(dfx --identity default canister call swap permission_find_by_user "(principal \"$DEFAULT\")" 2>&1)" '( vec { "PauseQuery"; "PauseReplace"; "PermissionQuery"; "PermissionFind"; "PermissionUpdate"; "ScheduleFind"; "ScheduleReplace"; "ScheduleTrigger"; "BusinessConfigFeeTo"; "BusinessConfigCustomToken"; "BusinessConfigMaintaining"; "BusinessTokenBalanceBy"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairCreateOrRemove"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap";}, )'
// test "permission_find_by_user" "$(dfx --identity default canister call swap permission_find_by_user "(principal \"$ALICE\")" 2>&1)" '( vec { "PauseQuery"; "PermissionQuery"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'
// test "🙈 permission_find_by_user" "$(dfx --identity alice canister call swap permission_find_by_user "(principal \"$DEFAULT\")" 2>&1)" "'PermissionFind' is required"
// test "🙈 permission_find_by_user" "$(dfx --identity alice canister call swap permission_find_by_user "(principal \"$ALICE\")" 2>&1)" "'PermissionFind' is required"

// blue "\n🚩 4.3 permission roles"
// test "permission_query" "$(dfx --identity alice canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PermissionQuery"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'
// test "permission_update" "$(dfx --identity default canister call swap permission_update "(vec { variant { UpdateRolePermission=record{\"Admin\"; opt vec {\"PauseReplace\"; \"PauseQuery\"} } } })" 2>&1)" "()"
// test "permission_update" "$(dfx --identity default canister call swap permission_update "(vec { variant { UpdateUserRole=record{principal \"$ALICE\"; opt vec {\"Admin\"} } } })" 2>&1)" "()"
// test "permission_query" "$(dfx --identity alice canister call swap permission_query 2>&1)" '( vec { "PauseReplace"; "PermissionQuery"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'
// test "permission_update" "$(dfx --identity default canister call swap permission_update "(vec { variant { UpdateUserRole=record{principal \"$ALICE\"; null } } })" 2>&1)" "()"
// test "permission_query" "$(dfx --identity alice canister call swap permission_query 2>&1)" '( vec { "PauseQuery"; "PermissionQuery"; "BusinessTokenDeposit"; "BusinessTokenWithdraw"; "BusinessTokenTransfer"; "BusinessTokenPairLiquidityAdd"; "BusinessTokenPairLiquidityRemove"; "BusinessTokenPairSwap"; }, )'

// blue "\n🚩 5.1 pause permission"
// test "pause_query" "$(dfx --identity default canister call swap pause_query 2>&1)" "(false)"
// test "pause_query_reason" "$(dfx --identity default canister call swap pause_query_reason 2>&1)" "(null)"
// test "pause_replace" "$(dfx --identity default canister call swap pause_replace "(opt \"reason\")" 2>&1)" "()"
// test "pause_query" "$(dfx --identity default canister call swap pause_query 2>&1)" "(true)"
// test "pause_query_reason" "$(dfx --identity default canister call swap pause_query_reason 2>&1)" "message = \"reason\""

// blue "\n🚩 5.2 pause permission by alice"
// test "pause_query" "$(dfx --identity alice canister call swap pause_query 2>&1)" "(true)"
// test "pause_query_reason" "$(dfx --identity alice canister call swap pause_query_reason 2>&1)" "message = \"reason\""

// blue "\n🚩 5.3 pause no permission"
// test "🙈 pause_replace" "$(dfx --identity alice canister call swap pause_replace "(null)" 2>&1)" "'PauseReplace' is required"
// test "permission_update" "$(dfx --identity default canister call swap permission_update "(vec { variant { UpdateUserPermission=record{principal \"$ALICE\"; opt vec { \"PauseReplace\";\"PauseQuery\" } } } })" 2>&1)" "()"
// test "pause_replace" "$(dfx --identity alice canister call swap pause_replace "(null)" 2>&1)" "()"
// test "🙈 pause_query" "$(dfx --identity alice canister call swap pause_query 2>&1)" "'PauseQuery' is required"
// test "🙈 pause_query_reason" "$(dfx --identity alice canister call swap pause_query_reason 2>&1)" "'PauseQuery' is required"
// test "pause_query" "$(dfx --identity default canister call swap pause_query 2>&1)" "(false)"
// test "pause_query_reason" "$(dfx --identity default canister call swap pause_query_reason 2>&1)" "(null)"

// blue "\n🚩 6 schedule"
// test "🙈 schedule_find" "$(dfx --identity alice canister call swap schedule_find 2>&1)" "'ScheduleFind' is required"
// test "schedule_find" "$(dfx --identity default canister call swap schedule_find 2>&1)" "(null)"
// test "🙈 schedule_replace" "$(dfx --identity alice canister call swap schedule_replace "(opt (1000000000:nat64))" 2>&1)" "'ScheduleReplace' is required"
// test "schedule_replace" "$(dfx --identity default canister call swap schedule_replace "(opt (1000000000:nat64))" 2>&1)" "()"
// sleep 3
// test "schedule_replace" "$(dfx --identity default canister call swap schedule_replace "(null)" 2>&1)" "()"
// sleep 2
// test "🙈 schedule_trigger" "$(dfx --identity alice canister call swap schedule_trigger 2>&1)" "'ScheduleTrigger' is required"
// test "schedule_trigger" "$(dfx --identity default canister call swap schedule_trigger 2>&1)" "()"

// blue "\n🚩 7 test swap data"
// test "pause_replace" "$(dfx --identity default canister call swap pause_replace "(opt \"reason\")" 2>&1)" "()"
// test "pause_query" "$(dfx --identity default canister call swap pause_query 2>&1)" "(true)"
// dfx canister install --mode=upgrade --upgrade-unchanged --argument "(null)" swap
// test "pause_replace" "$(dfx --identity default canister call swap pause_replace "(null)" 2>&1)" "()"
// test "pause_query" "$(dfx --identity default canister call swap pause_query 2>&1)" "(false)"

// blue "\n🚩 8 test archive-token"
// test "config_token_block_chain_query" "$(dfx --identity default canister call swap config_token_block_chain_query "(variant {BlockChainQuery})" --output json 2>&1)" '{ "Ok": { "BlockChain": { "archive_config": { "maintainers": [ [ "'"$DEFAULT"'" ] ], "max_length": "1000000", "max_memory_size_bytes": [] }, "archived": [], "current_archiving": [ { "block_height_offset": "0", "canister_id": "ykio2-paaaa-aaaaj-az5ka-cai", "length": "41", "max_length": "1000000" } ], "latest_block_hash": [' '], "next_block_index": "41" } } }'
// test "config_token_archive_wasm_module_query" "$(dfx --identity default canister call swap config_token_block_chain_query "(variant {WasmModuleQuery})" --output json 2>&1)" '{ "Ok": { "WasmModule": [ [ ' ' ] ] } }'
// test "config_token_archive_wasm_module_replace" "$(dfx --identity default canister call swap config_token_block_chain_update "(variant { WasmModuleUpdate=vec { 1: nat8; 2: nat8; 3: nat8}})" 2>&1)" '{ Ok = variant { WasmModule = opt blob'
// test "config_token_archive_wasm_module_query" "$(dfx --identity default canister call swap config_token_block_chain_query "(variant {WasmModuleQuery})" --output json 2>&1)" '{ "Ok": { "WasmModule": [ [ 1, 2, 3 ] ] } }'
// test "config_token_current_archiving_max_length_replace" "$(dfx --identity default canister call swap config_token_block_chain_update "(variant { CurrentArchivingMaxLengthUpdate=1000:nat64 })" 2>&1)" '( variant { Ok = variant { CurrentArchivingMaxLength = opt record { canister_id = principal "ykio2-paaaa-aaaaj-az5ka-cai"; length = 41 : nat64; max_length = 1_000 : nat64; block_height_offset = 0 : nat64; } } }, )'
// test "config_token_block_chain_query" "$(dfx --identity default canister call swap config_token_block_chain_query "(variant {BlockChainQuery})" --output json 2>&1)" '{ "archive_config": { "maintainers": [ [ "'"$DEFAULT"'" ] ], "max_length": "1000", "max_memory_size_bytes": [] }, "archived": [], "current_archiving": [ { "block_height_offset": "0", "canister_id": "ykio2-paaaa-aaaaj-az5ka-cai", "length": "41", "max_length": "1000" } ], "latest_block_hash": [' '], "next_block_index": "41" }'
// test "config_token_archive_config_replace" "$(dfx --identity default canister call swap config_token_block_chain_update "(variant { NextArchiveCanisterConfigUpdate = record {maintainers=opt vec{principal \"$BOB\"}; max_memory_size_bytes=opt (2000000:nat64); max_length=10000:nat64}})" 2>&1)" '( variant { Ok = variant { NextArchiveCanisterConfig = record { maintainers = opt vec { principal "'"$DEFAULT"'"; }; max_memory_size_bytes = null; max_length = 1_000 : nat64; } } }, )'
// test "config_token_block_chain_query" "$(dfx --identity default canister call swap config_token_block_chain_query "(variant {BlockChainQuery})" --output json 2>&1)" '{ "archive_config": { "maintainers": [ [ "'"$BOB"'" ] ], "max_length": "10000", "max_memory_size_bytes": [ "2000000" ] }, "archived": [], "current_archiving": [ { "block_height_offset": "0", "canister_id": "ykio2-paaaa-aaaaj-az5ka-cai", "length": "41", "max_length": "1000" } ], "latest_block_hash": [' '], "next_block_index": "41" }'
// test "config_token_archived_canister_maintainers_set" "$(dfx --identity default canister call swap config_token_block_chain_update "(variant { ArchivedCanisterMaintainersUpdate=record{canister_id=principal \"$archive_token\"; maintainers=opt vec {principal \"$ALICE\"};}})" 2>&1)" '(variant { Ok = variant { ArchivedCanisterMaintainers } })'
// test "config_token_archived_canister_max_memory_size_bytes_set" "$(dfx --identity default canister call swap config_token_block_chain_update "(variant { ArchivedCanisterMaxMemorySizeBytesUpdate=record{canister_id=principal \"$archive_token\"; max_memory_size_bytes=300: nat64}})" 2>&1)" 'Cannot set max_memory_size_bytes to 300, because it is lower than total_block_size 6294'
// test "config_token_archived_canister_max_memory_size_bytes_set" "$(dfx --identity default canister call swap config_token_block_chain_update "(variant { ArchivedCanisterMaxMemorySizeBytesUpdate=record{canister_id=principal \"$archive_token\"; max_memory_size_bytes=3_000_000: nat64}})" 2>&1)" '(variant { Ok = variant { ArchivedCanisterMaxMemorySizeBytes } })'

// blue "\n🚩 8.1 test archive-token"
// test "get_blocks" "$(dfx --identity default canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" 2>&1)" 'Only Maintainers are allowed to query data'
// test "get_blocks" "$(dfx --identity bob canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" 2>&1)" 'Only Maintainers are allowed to query data'
// test "get_blocks" "$(dfx --identity default canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" 2>&1)" 'Only Maintainers are allowed to query data'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '{ "Ok": { "blocks": [ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "5_000_000_000_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "1_000_000_000_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_000_000_000_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$ALICE"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "800_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "2_000_000_000_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "400_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "894_427_190_999_915", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "447_213_595_499_958", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_000_000_000_000_001_118", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "200_000_000_000", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "20_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "10_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "200_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "44_721_359_549", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "100_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_974_316_068", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_314_083", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "25_683_932", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "2_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "100_000_000_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "14_142_135_623_730", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy" } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "20_000", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "390_851", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "1_948_388_438_775", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "38_850", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "to": { "owner": "'"$BOB"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "20_000", "from": { "owner": "'"$BOB"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "200_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "200_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "token": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "3_832_845_479", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 129, 192, 159, 10, 187, 219, 171, 138, 212, 6, 16, 125, 179, 209, 133, 136, 182, 103, 235, 148, 243, 190, 106, 85, 108, 227, 107, 136, 117, 203, 137, 150 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "3_832_845_479", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "101_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "100_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$ALICE"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "2_236_063_620", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "447", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "100_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "19_940", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "11_194", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [] }, "to": { "owner": "'"$BOB"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "withdraw": { "amount": "101_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "deposit": { "amount": "100_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$ALICE"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "2_236_064_344", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity alice canister call $archive_token get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "transfer": { "amount": "447", "fee": [], "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } ] } }'

// blue "\n🚩 9 test archive-swap"
// test "config_swap_block_chain_query" "$(dfx --identity default canister call swap config_swap_block_chain_query "(variant {BlockChainQuery})" --output json 2>&1)" '{ "Ok": { "BlockChain": { "archive_config": { "maintainers": [], "max_length": "1000000", "max_memory_size_bytes": [] }, "archived": [], "current_archiving": [ { "block_height_offset": "0", "canister_id": "hcnys-xiaaa-aaaai-q3w4q-cai", "length": "30", "max_length": "1000000" } ], "latest_block_hash": [' '], "next_block_index": "30" } } }'
// test "config_swap_archive_wasm_module_query" "$(dfx --identity default canister call swap config_swap_block_chain_query "(variant {WasmModuleQuery})" --output json 2>&1)" '{ "Ok": { "WasmModule": [ [ ' ' ] ] } }'
// test "config_swap_archive_wasm_module_replace" "$(dfx --identity default canister call swap config_swap_block_chain_update "(variant { WasmModuleUpdate=vec { 1: nat8; 2: nat8; 3: nat8}})" 2>&1)" '{ Ok = variant { WasmModule = opt blob'
// test "config_swap_archive_wasm_module_query" "$(dfx --identity default canister call swap config_swap_block_chain_query "(variant {WasmModuleQuery})" --output json 2>&1)" '{ "Ok": { "WasmModule": [ [ 1, 2, 3 ] ] } }'
// test "config_swap_current_archiving_max_length_replace" "$(dfx --identity default canister call swap config_swap_block_chain_update "(variant { CurrentArchivingMaxLengthUpdate=1000:nat64 })" 2>&1)" '( variant { Ok = variant { CurrentArchivingMaxLength = opt record { canister_id = principal "hcnys-xiaaa-aaaai-q3w4q-cai"; length = 30 : nat64; max_length = 1_000 : nat64; block_height_offset = 0 : nat64; } } }, )'
// test "config_swap_block_chain_query" "$(dfx --identity default canister call swap config_swap_block_chain_query "(variant {BlockChainQuery})" --output json 2>&1)" '{ "Ok": { "BlockChain": { "archive_config": { "maintainers": [], "max_length": "1000", "max_memory_size_bytes": [] }, "archived": [], "current_archiving": [ { "block_height_offset": "0", "canister_id": "hcnys-xiaaa-aaaai-q3w4q-cai", "length": "30", "max_length": "1000" } ], "latest_block_hash": [' '], "next_block_index": "30" } } }'
// test "config_swap_archive_config_replace" "$(dfx --identity default canister call swap config_swap_block_chain_update "(variant { NextArchiveCanisterConfigUpdate = record {maintainers=opt vec{principal \"$BOB\"}; max_memory_size_bytes=opt (2000000:nat64); max_length=10000:nat64}})" 2>&1)" '( variant { Ok = variant { NextArchiveCanisterConfig = record { maintainers = null; max_memory_size_bytes = null; max_length = 1_000 : nat64; } } }, )'
// test "config_swap_block_chain_query" "$(dfx --identity default canister call swap config_swap_block_chain_query "(variant {BlockChainQuery})" --output json 2>&1)" '{ "Ok": { "BlockChain": { "archive_config": { "maintainers": [ [ "'"$BOB"'" ] ], "max_length": "10000", "max_memory_size_bytes": [ "2000000" ] }, "archived": [], "current_archiving": [ { "block_height_offset": "0", "canister_id": "hcnys-xiaaa-aaaai-q3w4q-cai", "length": "30", "max_length": "1000" } ], "latest_block_hash": [' '], "next_block_index": "30" } } }'
// test "config_swap_archived_canister_maintainers_set" "$(dfx --identity default canister call swap config_swap_block_chain_update "(variant { ArchivedCanisterMaintainersUpdate=record{canister_id=principal \"$archive_swap\"; maintainers=opt vec {principal \"$ALICE\"};}})" 2>&1)" '(variant { Ok = variant { ArchivedCanisterMaintainers } })'
// test "config_swap_archived_canister_max_memory_size_bytes_set" "$(dfx --identity default canister call swap config_swap_block_chain_update "(variant { ArchivedCanisterMaxMemorySizeBytesUpdate=record{canister_id=principal \"$archive_swap\"; max_memory_size_bytes=300: nat64}})" 2>&1)" 'Cannot set max_memory_size_bytes to 300, because it is lower than total_block_size 5917'
// test "config_swap_archived_canister_max_memory_size_bytes_set" "$(dfx --identity default canister call swap config_swap_block_chain_update "(variant { ArchivedCanisterMaxMemorySizeBytesUpdate=record{canister_id=principal \"$archive_swap\"; max_memory_size_bytes=3_000_000: nat64}})" 2>&1)" '(variant { Ok = variant { ArchivedCanisterMaxMemorySizeBytes } })'

// blue "\n🚩 9.1 test archive-swap"
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" 2>&1)" 'Only Maintainers are allowed to query data'
// test "config_swap_archived_canister_maintainers_set" "$(dfx --identity alice canister call swap config_swap_block_chain_update "(variant { ArchivedCanisterMaintainersUpdate=record{canister_id=principal \"$archive_swap\"; maintainers=null}})" 2>&1)" "'BusinessConfigMaintaining' is required"
// test "config_swap_archived_canister_maintainers_set" "$(dfx --identity default canister call swap config_swap_block_chain_update "(variant { ArchivedCanisterMaintainersUpdate=record{canister_id=principal \"$archive_swap\"; maintainers=null}})" 2>&1)" '(variant { Ok = variant { ArchivedCanisterMaintainers } })'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '{ "Ok": { "blocks": [ { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "create": { "creator": "'"$DEFAULT"'", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint": { "amount": "894_427_190_999_915", "amount0": "2_000_000_000_000_000_000", "amount1": "400_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "burn": { "amount": "447_213_595_499_958", "amount0": "1_000_000_000_000_001_118", "amount1": "200_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint": { "amount": "894_427_190_999_915", "amount0": "2_000_000_000_000_000_000", "amount1": "400_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "0", "price1_cumulative": "0", "price_cumulative_exponent": 64, "reserve0": "2_000_000_000_000_000_000", "reserve1": "400_000_000_000", "supply": "894_427_190_999_915" } } } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "burn": { "amount": "447_213_595_499_958", "amount0": "1_000_000_000_000_001_118", "amount1": "200_000_000_000", "fee": [], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "999_999_999_999_998_882", "reserve1": "200_000_000_000", "supply": "447_213_595_499_957" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "create": { "creator": "'"$DEFAULT"'", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint": { "amount": "44_721_359_549", "amount0": "10_000_000_000", "amount1": "200_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "kvdti-w4byc-pqvo6-3vofn-ibqqp-wz5db-miwzt-6xfht-xzvfk-3hdno-ehk", "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "0", "price1_cumulative": "0", "price_cumulative_exponent": 64, "reserve0": "10_000_000_000", "reserve1": "200_000_000_000", "supply": "44_721_359_549" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "100_000_000", "amount_b": "1_974_316_068", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_100_000_000", "reserve1": "198_025_683_932", "supply": "44_721_359_549" } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "1_314_083", "amount_b": "25_683_932", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_101_314_083", "reserve1": "198_000_000_000", "supply": "44_721_359_549" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "create": { "creator": "'"$DEFAULT"'", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint": { "amount": "14_142_135_623_730", "amount0": "2_000_000_000", "amount1": "100_000_000_000_000_000", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "3gnkd-hecbp-53pbw-rofaw-b6vu3-76hvz-2yb33-p2lp2-zov2r-gryij-hmy", "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "price0_cumulative": "0", "price1_cumulative": "0", "price_cumulative_exponent": 64, "reserve0": "2_000_000_000", "reserve1": "100_000_000_000_000_000", "supply": "14_142_135_623_730" } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "20_000", "amount_b": "390_851", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_101_334_083", "reserve1": "197_999_609_149", "supply": "44_721_359_549" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "390_851", "amount_b": "1_948_388_438_775", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 17, 223, 250, 53, 253, 66, 129, 15, 155, 36, 156, 57, 116, 157, 74, 220, 115, 163, 151, 247, 153, 249, 7, 3, 191, 109, 143, 204, 30, 247, 217, 44 ] ] }, "to": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "token_a": "cngnf-vqaaa-aaaar-qag4q-cai", "token_b": "ss2fx-dyaaa-aaaar-qacoq-cai" } } } } }, { "parent_hash": ['
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "999_998_051_611_560_107", "reserve1": "200_000_390_851", "supply": "447_213_595_499_957" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "1_948_388_438_775", "amount_b": "38_850", "from": { "owner": "piwiu-wiaaa-aaaaj-azzka-cai", "subaccount": [ [ 130, 11, 251, 183, 134, 209, 113, 65, 96, 250, 180, 223, 252, 122, 231, 88, 14, 246, 253, 45, 250, 203, 171, 168, 154, 56, 66, 78, 204, 132, 164, 37 ] ] }, "to": { "owner": "'"$BOB"'", "subaccount": [] }, "token_a": "ss2fx-dyaaa-aaaar-qacoq-cai", "token_b": "ryjl3-tyaaa-aaaaa-aaaba-cai" } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "ss2fx-dyaaa-aaaar-qacoq-cai" } }, "price0_cumulative": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "1_999_961_150", "reserve1": "100_001_948_388_438_775", "supply": "14_142_135_623_730" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "200_000_000", "amount_b": "3_832_845_479", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ryjl3-tyaaa-aaaaa-aaaba-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "10_301_334_083", "reserve1": "194_166_763_670", "supply": "44_721_359_549" } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "burn": { "amount": "1_000_000", "amount0": "2_236_063_620", "amount1": "447", "fee": [ { "fee": "100_000_000", "fee_to": { "owner": "'"$ALICE"'", "subaccount": [] } } ], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "999_998_049_375_496_487", "reserve1": "200_000_390_404", "supply": "447_213_494_499_957" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap": { "amm": { "swap_v2_0.3%": null }, "amount_a": "100_000_000_000", "amount_b": "19_940", "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token_a": "ss2fx-dyaaa-aaaar-qacoq-cai", "token_b": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "999_998_149_375_496_487", "reserve1": "200_000_370_464", "supply": "447_213_494_499_957" } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "mint_fee": { "amount": "11_194", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$BOB"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4" } } } } } }, { "parent_hash": [' '], "timestamp": "' '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "burn": { "amount": "1_000_000", "amount0": "2_236_064_344", "amount1": "447", "fee": [ { "fee": "100_000_000", "fee_to": { "owner": "'"$ALICE"'", "subaccount": [] } } ], "from": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "to": { "owner": "'"$DEFAULT"'", "subaccount": [] }, "token": "vbofh-iir37-5dl7k-cqehz-wje4h-f2j2s-w4oor-zp54z-7edqh-p3nr7-gb4", "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } } } } } }, { "parent_hash": [' '], "timestamp": "'
// test "get_blocks" "$(dfx --identity bob canister call $archive_swap get_blocks "(record {start=0:nat64;length=100:nat64})" --output json 2>&1)" '", "transaction": { "created": [], "memo": [], "operation": { "pair": { "swap_v2": { "state": { "block_timestamp": "' '", "pa": { "amm": { "swap_v2_0.3%": null }, "pair": { "token0": "ss2fx-dyaaa-aaaar-qacoq-cai", "token1": "cngnf-vqaaa-aaaar-qag4q-cai" } }, "price0_cumulative": "' '", "price1_cumulative": "' '", "price_cumulative_exponent": 64, "reserve0": "999_998_147_139_432_143", "reserve1": "200_000_370_017", "supply": "447_213_393_511_151" } } } } } } ] } }'

// blue "\n🚩 10 test request trace"
// test "request_trace_index_get" "$(dfx --identity bob canister call swap request_trace_index_get 2>&1)" "Permission 'BusinessConfigMaintaining' is required"
// test "request_trace_index_get" "$(dfx --identity default canister call swap request_trace_index_get 2>&1)" '(0 : nat64, 22 : nat64)'
// test "request_trace_get" "$(dfx --identity alice canister call swap request_trace_get "(0:nat64)" 2>&1)" "Permission 'BusinessConfigMaintaining' is required"
// test "request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(0:nat64)" 2>&1)" '( opt record { created = ' ' : nat64; args = variant { token_deposit = record { arg = record { to = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; token = principal "ss2fx-dyaaa-aaaar-qacoq-cai"; from = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; amount = 5_000_000_000_000_000_000 : nat; }; now = ' ' : nat64; created = null; memo = null; caller = principal "'"$DEFAULT"'"; } }; done = opt record { result = variant { ok = "4" }; done = ' ' : nat64; }; traces = vec { record { ' ' : nat64; "*Deposit* `token:[ss2fx-dyaaa-aaaar-qacoq-cai], from:('"$DEFAULT"'.), to:('"$DEFAULT"'.), amount:5_000_000_000_000_000_000, height:4`"; }; record { ' ' : nat64; "Deposit Done." }; }; locks = record { token = opt true; swap = null; balances = opt vec { record { token = principal "ss2fx-dyaaa-aaaar-qacoq-cai"; account = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; }; }; }; index = 0 : nat64; }, )'
// test "request_trace_remove" "$(dfx --identity bob canister call swap request_trace_remove "(0:nat64)" 2>&1)" "Permission 'BusinessConfigMaintaining' is required"
// test "request_trace_remove" "$(dfx --identity default canister call swap request_trace_remove "(10:nat64)" 2>&1)" 'must remove min request index: 0'
// test "request_trace_remove" "$(dfx --identity default canister call swap request_trace_remove "(0:nat64)" 2>&1)" '( opt record { created = ' ' : nat64; args = variant { token_deposit = record { arg = record { to = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; token = principal "ss2fx-dyaaa-aaaar-qacoq-cai"; from = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; amount = 5_000_000_000_000_000_000 : nat; }; now = ' ' : nat64; created = null; memo = null; caller = principal "'"$DEFAULT"'"; } }; done = opt record { result = variant { ok = "4" }; done = ' ' : nat64; }; traces = vec { record { ' ' : nat64; "*Deposit* `token:[ss2fx-dyaaa-aaaar-qacoq-cai], from:('"$DEFAULT"'.), to:('"$DEFAULT"'.), amount:5_000_000_000_000_000_000, height:4`"; }; record { ' ' : nat64; "Deposit Done." }; }; locks = record { token = opt true; swap = null; balances = opt vec { record { token = principal "ss2fx-dyaaa-aaaar-qacoq-cai"; account = record { owner = principal "'"$DEFAULT"'"; subaccount = null; }; }; }; }; index = 0 : nat64; }, )'
// test "request_trace_get" "$(dfx --identity default canister call swap request_trace_get "(0:nat64)" 2>&1)" '(null)'
// test "request_trace_index_get" "$(dfx --identity bob canister call swap request_trace_index_get 2>&1)" "Permission 'BusinessConfigMaintaining' is required"
// test "request_trace_index_get" "$(dfx --identity default canister call swap request_trace_index_get 2>&1)" '(1 : nat64, 21 : nat64)'
// test "request_trace_remove" "$(dfx --identity default canister call swap request_trace_remove "(10:nat64)" 2>&1)" 'must remove min request index: 1'

}

fn deploy_icrc2<'a>(
    pic: &'a PocketIc,
    sender: Principal,
    canister_id: Principal,
    symbol: &str,
    decimals: u8,
    transfer_fee: u64,
    initial_balances: Vec<(Principal, u64)>,
    fee_collector: Principal,
) -> icrc2::PocketedCanisterId<'a> {
    use icrc2::*;

    pic.create_canister_with_id(Some(sender), None, canister_id).unwrap();
    pic.add_cycles(canister_id, INIT_CYCLES);
    pic.install_canister(
        canister_id,
        ICRC2_WASM_MODULE.to_vec(),
        encode_one(LedgerArgument::Init(InitArgs {
            token_name: symbol.to_string(),
            token_symbol: symbol.to_string(),
            decimals: Some(decimals),
            transfer_fee: Nat::from(transfer_fee),
            metadata: vec![],
            minting_account: Account {
                owner: Principal::from_text("aaaaa-aa").unwrap(),
                subaccount: None,
            },
            initial_balances: initial_balances
                .into_iter()
                .map(|(owner, balance)| {
                    (
                        Account {
                            owner,
                            subaccount: None,
                        },
                        Nat::from(balance),
                    )
                })
                .collect(),
            fee_collector_account: Some(Account {
                owner: fee_collector,
                subaccount: None,
            }),
            archive_options: ArchiveOptions {
                num_blocks_to_archive: 1000,
                max_transactions_per_response: None,
                trigger_threshold: 1000,
                more_controller_ids: None,
                max_message_size_bytes: None,
                cycles_for_archive_creation: None,
                node_max_memory_size_bytes: None,
                controller_id: Principal::from_text("aaaaa-aa").unwrap(),
            },
            max_memo_length: None,
            feature_flags: Some(FeatureFlags { icrc2: true }),
        }))
        .unwrap(),
        Some(sender),
    );

    icrc2::PocketedCanisterId::new(canister_id, &pic)
}

fn assert_token_block_deposit(block: archive_token::TokenBlock, deposit: archive_token::DepositToken) {
    if let archive_token::TokenOperation::Deposit(deposit_token) = block.transaction.operation {
        assert_eq!(deposit_token, deposit);
    } else {
        panic!("Expected DepositToken, got {:?}", block);
    }
}
fn assert_token_block_withdraw(block: archive_token::TokenBlock, withdraw: archive_token::DepositToken) {
    if let archive_token::TokenOperation::Withdraw(withdraw_token) = block.transaction.operation {
        assert_eq!(withdraw_token, withdraw);
    } else {
        panic!("Expected WithdrawToken, got {:?}", block);
    }
}
fn assert_token_block_transfer(block: archive_token::TokenBlock, transfer: archive_token::TransferToken) {
    if let archive_token::TokenOperation::Transfer(transfer_token) = block.transaction.operation {
        assert_eq!(transfer_token, transfer);
    } else {
        panic!("Expected TransferToken, got {:?}", block);
    }
}

fn assert_tokens_balance(balances: Vec<(Principal, Nat)>, required: Vec<(Principal, Nat)>) {
    for r in required {
        if !balances.contains(&r) {
            if let Some((p, b)) = balances.iter().find(|(p, _)| *p == r.0) {
                panic!(
                    "Expected balance ({}, {}) but got ({}, {b:?})",
                    r.0.to_text(),
                    r.1,
                    p.to_text(),
                );
            } else {
                panic!(
                    "Expected balance ({}, {}) but not found, got {balances:?}",
                    r.0.to_text(),
                    r.1,
                );
            }
        }
    }
}

fn assert_swap_block_pair_create(block: archive_swap::SwapBlock, create: archive_swap::PairCreate) {
    if let archive_swap::SwapOperation::Pair(archive_swap::PairOperation::Create(c)) = block.transaction.operation {
        assert_eq!(c, create);
    } else {
        panic!("Expected PairCreate, got {:?}", block);
    }
}
